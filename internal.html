

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7. Internal Procedures (Under construction) &#8212; RFS Tag</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/hacks.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'internal';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="6. Technology (Under construction)" href="technology.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/nfc-logo-red-sm.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/nfc-logo-red-sm.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    RFS Tag User Guide
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="background.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="kiosk.html">2. The Kiosk</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">3. Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">4. Web Portal</a></li>
<li class="toctree-l1"><a class="reference internal" href="administration.html">5. Administration Procedures (Under construction)</a></li>
<li class="toctree-l1"><a class="reference internal" href="technology.html">6. Technology (Under construction)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">7. Internal Procedures (Under construction)</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/internal.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Internal Procedures (Under construction)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">7. Internal Procedures (Under construction)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-brigade">7.1. Adding a New Brigade</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-required-from-brigade">7.1.1. Data Required from Brigade</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-order-parts-list">7.1.2. Hardware Order Parts List</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#equipment-to-be-provided-by-brigade">7.1.3. Equipment to be Provided by Brigade</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-tenant-schema">7.1.4. Adding a New Tenant Schema</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-a-new-kiosk-raspberry-pi">7.1.5. Setting Up a New Kiosk Raspberry PI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-the-kiosk-software-apt-procedure">7.1.6. Installing the Kiosk Software (apt procedure)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-preparation">7.1.6.1. Initial Preparation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#add-the-rfstag-kiosk-repository-one-off-procedure">7.1.6.2. Add the rfstag-kiosk repository (one-off procedure)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pi-display-problems-and-vnc-connections">7.1.6.3. PI display problems and VNC connections</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#first-installation">7.1.6.4. First installation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#update-2024-08-22">7.1.6.5. Update 2024-08-22</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-the-nfcserver2-package">7.1.7. Building the nfcserver2 package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-screen-keyboard">7.1.8. On screen keyboard</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-activ-dashboard-on-the-pi">7.1.8.1. Running the ACTIV dashboard on the PI</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-the-kiosk-software-original-procedure">7.1.9. Installing the Kiosk Software (original procedure)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-login">7.1.10. First login</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-remote-it">7.1.11. Check remote.it</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">7.1.12. Testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-deployment-to-prd">7.1.13. Full Deployment to PRD</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-new-elasticache-on-aws">7.2. Create new Elasticache on AWS</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rds">7.3. RDS</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copy-prd-rds-to-dev-env">7.3.1. Copy prd RDS to dev env</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-models-migrations">7.3.2. Updating Models/Migrations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-credits-annual">7.4. AWS Credits (annual)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-userdocs">7.5. Updating userdocs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-pager-sub-system">7.6. Adding a New Pager Sub-system</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pi-won-t-boot">7.7. PI won’t boot</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-deployment">8. AWS Deployment</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-deployment-checklist">8.1. AWS Deployment Checklist</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings-for-web-application-deployment">8.2. Settings for Web Application Deployment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#django-settings">8.2.1. Django Settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-variables-as-settings">8.2.2. Environment Variables as settings</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#django-setting-allowed-hosts">8.2.2.1. Django Setting ALLOWED_HOSTS</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#development-environment-variables">8.2.2.2. Development Environment Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment-environment-variables">8.2.2.3. Deployment Environment Variables</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-resources">8.3. AWS Resources</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#relational-database-postgres-rds">8.3.1. Relational database (postgres RDS)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rds-setup">8.3.1.1. RDS Setup</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cache-redis-elasticache">8.3.2. Cache (REDIS Elasticache)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-file-storage-s3-bucket">8.3.3. Static file storage (S3 bucket)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logging-rotating-linux-logs">8.3.4. Logging (rotating linux logs)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ip-routing-route-53-hosted-zones">8.3.5. IP routing (Route 53 hosted zones)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ssl-certification-aws-certificate-manager">8.3.6. SSL certification (AWS Certificate Manager)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processor-disc-and-memory-elastic-beanstalk">8.3.7. Processor, disc and memory (Elastic Beanstalk)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-to-aws-eb-with-github-actions">8.3.7.1. Deploying to AWS EB with Github Actions</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#github-actions-settings">8.3.7.1.1. Github Actions Settings</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#github-actions-secrets-and-variables">8.3.7.1.2. Github Actions Secrets and Variables</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#elastic-beanstalk-extensions">8.3.7.2. Elastic Beanstalk Extensions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-eb-platform-settings">8.3.7.3. AWS EB .platform settings</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-confighooks">8.3.7.3.1. .platform confighooks</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-hooks">8.3.7.3.2. .platform hooks</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-nginx">8.3.7.3.3. .platform nginx</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#django-middleware">8.3.7.3.4. Django Middleware</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-low-cost-ec2-rds">8.3.8. Creating a low-cost EC2 RDS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#security-settings-mozilla-observatory">8.3.9. Security Settings Mozilla Observatory</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-eb-platforms">8.4. AWS EB Platforms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ec2-platform-version-upgrades">8.4.1. EC2 Platform Version Upgrades</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrading-ec2-platform">8.4.2. Upgrading EC2 Platform</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-issues-when-upgrading-ec2-platform">8.4.3. Common Issues when Upgrading EC2 Platform</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="internal-procedures-under-construction">
<h1><span class="section-number">7. </span>Internal Procedures (Under construction)<a class="headerlink" href="#internal-procedures-under-construction" title="Permalink to this headline">#</a></h1>
<aside class="margin sidebar">
<p class="sidebar-title">Restricted Access</p>
<p>For internal use only</p>
</aside>
<section id="adding-a-new-brigade">
<h2><span class="section-number">7.1. </span>Adding a New Brigade<a class="headerlink" href="#adding-a-new-brigade" title="Permalink to this headline">#</a></h2>
<section id="data-required-from-brigade">
<h3><span class="section-number">7.1.1. </span>Data Required from Brigade<a class="headerlink" href="#data-required-from-brigade" title="Permalink to this headline">#</a></h3>
<p>The brigade should provide the following details, preferably in an Excel spreadsheet:</p>
<ul class="simple">
<li><p>All Member Details (preferably from onerfs “Brigade Personnel Response Analysis” report), including</p>
<ul>
<li><p>Firezone number</p></li>
<li><p>First Name</p></li>
<li><p>Last Name</p></li>
<li><p>Preferred First Name</p></li>
<li><p>Mobile number</p></li>
<li><p>Email address</p></li>
<li><p>Date Joined</p></li>
<li><p>Date of Birth</p></li>
<li><p>Active status (yes/no)</p></li>
<li><p>Member Type (Operational/Reserve/Social/Administration/Support)</p></li>
</ul>
</li>
<li><p>Member Qualifications</p>
<ul>
<li><p>Brigade manager to obtain “Qualification Report” from onerfs Team Reports</p></li>
<li><p>see here for details: <a class="reference external" href="https://rfstag-user.netlify.app/administration.html#synchronising-qualifications-with-sap">Member Qualifications</a>.</p></li>
</ul>
</li>
<li><p>Current Officers (for all Field and Admin positions)</p>
<ul>
<li><p>Member Name</p></li>
<li><p>Member FireZone number</p></li>
<li><p>Position Title</p></li>
</ul>
</li>
<li><p>Brigade Vehicles</p>
<ul>
<li><p>Full name (e.g. Wyee Point 1A)</p></li>
<li><p>Abbrev name, eg. WP-1A</p></li>
<li><p>Make, eg. Isuzu</p></li>
<li><p>Category (eg. 1, 7, 9, …)</p></li>
<li><p>Year</p></li>
<li><p>Crew capacity</p></li>
<li><p>Aircraft Code</p></li>
</ul>
</li>
<li><p>Brigade Settings</p>
<ul>
<li><p>see <a class="reference internal" href="administration.html#brig-sett"><span class="std std-ref">Brigade Settings section</span></a> above</p></li>
<li><p>This can be done last, after all of the above</p></li>
</ul>
</li>
</ul>
</section>
<section id="hardware-order-parts-list">
<h3><span class="section-number">7.1.2. </span>Hardware Order Parts List<a class="headerlink" href="#hardware-order-parts-list" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Raspberry PI</p>
<ul>
<li><p>PI 4 2Gb RAM</p></li>
<li><p>PI 4 case</p></li>
<li><p>Micro HDMI cable</p></li>
<li><p>PI 4 power supply</p></li>
<li><p>16Gb SD RAM card</p></li>
</ul>
</li>
<li><p>Tags</p>
<ul>
<li><p>Sony PaSoRi RC-S380 card reader (USB)</p></li>
<li><p>100 x 13.56MHz NTAG215 NFC Key Fob Tags</p></li>
</ul>
</li>
</ul>
</section>
<section id="equipment-to-be-provided-by-brigade">
<h3><span class="section-number">7.1.3. </span>Equipment to be Provided by Brigade<a class="headerlink" href="#equipment-to-be-provided-by-brigade" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Kiosk</p>
<ul>
<li><p>Computer monitor with HDMI connection (can be touchscreen if available)</p></li>
<li><p>USB Mouse (preferably wired)</p></li>
<li><p>USB Keyboard (preferably wired)</p></li>
</ul>
</li>
<li><p>Wi-Fi connection</p>
<ul>
<li><p>SSID and password</p></li>
</ul>
</li>
</ul>
</section>
<section id="adding-a-new-tenant-schema">
<h3><span class="section-number">7.1.4. </span>Adding a New Tenant Schema<a class="headerlink" href="#adding-a-new-tenant-schema" title="Permalink to this headline">#</a></h3>
<p>Optional steps (when building schema on tst system) shown in <span class="opt">italics</span>.</p>
<p>Overview:</p>
<ul class="simple">
<li><p>Make a backup of the latest prd RDS -&gt; bushfire2-prd-YYMMDD</p>
<ul>
<li><p><a class="reference external" href="https://stackoverflow.com/questions/56462616/how-to-use-pg-restore-with-aws-rds-correctly-to-restore-postgresql-database">Revised procedure</a></p>
<ul>
<li><p>cd ~/kbfb/aws-backups/tst2$</p>
<ul>
<li><p><strong>pg_dump</strong> -h bushfire2-prd-rds5.c5b4rv0axnji.ap-southeast-2.rds.amazonaws.com -U ian -Fc ebdb2 &gt; bushfire2-prd-rds2-240731.dump</p></li>
<li><p>Password: ib15…</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Create new RDS in ec2 called bushfire2-prd-rds2-240731</p>
<ul>
<li><p><strong>pg_restore</strong> -h ec2-13-211-99-59.ap-southeast-2.compute.amazonaws.com -p 5432 –no-owner –no-privileges –role=ian -d bushfire2-prd-rds2-240731 bushfire2-prd-rds2-240731.dump</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Create a new empty database called bushfire2-prd-YYMMDD in the EC2 postgres server</p></li>
<li><p>Restore the prd backup to the new EC2 database</p></li>
<li><p>Make the tpad env point to the new EC2 database</p></li>
<li><p>Run bushfire2 on tpad, and complete set up and population as below</p></li>
<li><p>Update the config of tst6 using the AWS EB Console to point to the new EC2 tst6 database</p></li>
<li><p>Check everything runs ok at <newbrigade>.rfstag.org</p></li>
<li><p>If all ok, repeat the set up and population on the prd AWS RDS</p>
<ul>
<li><p>Do the initial setup by connecting tpad to the prd AWS RDS</p></li>
<li><p>Restart the PRD EB instance to clear all caches</p></li>
<li><p>Check all works on <newbrigade>.rfstag.com</p></li>
</ul>
</li>
<li><p>Make backups of any target databases using pgadmin</p>
<ul>
<li><p>Make backup of AWS production database (ebdb) on dev system using pgadmin</p>
<ul>
<li><p>Set inbound rule on RDS security group for MyIP if needed</p></li>
</ul>
</li>
<li><p><span class="opt">Create a new empty database bushfire2-prd-YYMMDD on the EC2 postgresql using pgadmin</span></p></li>
<li><p><span class="opt">Restore backup of AWS production database to the new EC2 database using EC2 postgresql</span></p></li>
</ul>
</li>
</ul>
<p>Procedure</p>
<ul class="simple">
<li><p>In pycharm project bushfire2:</p>
<ul>
<li><p>In bushfire/settings/.env set RDS_HOSTNAME=<span class="opt">”ec2-13-211-99-59.ap-southeast-2.compute.amazonaws.com”</span></p>
<ul>
<li><p>Also set RDS_DB_NAME=bushfire2-prd-YYMMDD in .env</p></li>
</ul>
</li>
<li><p>Check all migrations in all apps saved in github</p></li>
<li><p>Add new tenant name to settings.base.CUSTOMER_LIST</p></li>
<li><p>Run/Edit Configurations</p>
<ul>
<li><p>Env vars: PYTHONUNBUFFERED=1;DJANGO_SETTINGS_MODULE=bushfire.settings.local</p></li>
<li><p>Working directory: ~/PycharmProjects/bushfire2</p></li>
<li><p>Script path: /home/ian/PycharmProjects/bushfire2/manage.py</p>
<ul>
<li><p>createBrigade Parameters:</p>
<ul>
<li><p>python manage.py createBrigade <span class="opt">Cambewarra</span> –short <span class="opt">CBW</span> –host <span class="opt">rfstag.com</span></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Run createBrigade in a Python runtime environment</p></li>
</ul>
</li>
<li><p>In Terminal window (note that arguments don’t appear to work on command line):</p>
<ul>
<li><p>(bushfire2) ian&#64;ian-ThinkPad-T490:~/PycharmProjects/bushfire2$ python manage.py create_tenant_superuser</p></li>
<li><p>Enter Tenant Schema (‘?’ to list schemas): <span class="opt">cambewarra</span></p></li>
<li><p>Username (leave blank to use ‘ian’): admin</p></li>
<li><p>Email address: ibowditch&#64;gmail.com</p></li>
<li><p>Password:</p></li>
<li><p>Password (again):</p></li>
<li><p>Superuser created successfully.</p></li>
</ul>
</li>
<li><p>Set Run/Edit Configurations for setupBrigade as for createBrigade</p>
<ul>
<li><p>Parameters: python manage.py setupBrigade <span class="opt">Cambewarra</span></p></li>
<li><p>Run setupBrigade environment</p></li>
</ul>
</li>
<li><p>Set Run/Edit Configurations for set_tenant_domains</p>
<ul>
<li><p>IMPORTANT!!!</p></li>
<li><p>Parameters: python manage.py set_tenant_domains</p></li>
<li><p>Run set_tenant_domains environment</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Add new domain to tpad /etc/hosts</p></li>
<li><p>Login to admin into the new tenant using admin user</p></li>
<li><p>Change tenant name to readable version, eg. Gosford Bulk (with space) using signin.org</p></li>
<li><ul>
<li><p><strong>NOW RESTART APPLICATION SERVER</strong></p></li>
</ul>
</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  * All might look ok, but probably isn&#39;t
  * Need to clear caches to rds (?)
  * If it doesn&#39;t restart, often get weird, scary, server crashes about 36h after adding new tenant
</pre></div>
</div>
<ul class="simple">
<li><p>Login to admin into the new tenant using admin user</p>
<ul>
<li><p>Check passwords for utility users kiosk, tagadmin, pager are set, and if not set to correct values</p></li>
<li><p>Import Members from provided list</p>
<ul>
<li><p>Check that all members have unique email addresses</p></li>
<li><p>NB: Make sure to generate and use a csv file for member import. xlsx can hang server.</p></li>
</ul>
</li>
<li><p>Set up Officers for previous year with provided details (once set up in dev, export for use in AWS updates)</p>
<ul>
<li><p>Check Groups assigned properly (esp. Training, Personnel)</p></li>
<li><p>Try to get order of DCs (not included in onerfs report)</p></li>
</ul>
</li>
<li><p>Set Brigade Details</p>
<ul>
<li><p>All activity types are valid: deselect External and any others</p></li>
<li><p>Check social as excluded</p></li>
<li><p>Set season start date (ignore year)</p></li>
<li><p>Set activity types</p></li>
<li><p>Set excluded activities</p></li>
<li><p>Check and update location, phone number, etc.</p></li>
<li><p>Add pager capcode and region</p></li>
</ul>
</li>
<li><p>Add tenant name to relevant entry in kbfb/media/public/capcodes.csv (may be deprecated at some point)</p></li>
<li><p>Import qualifications from RFS list under admin certifications/import</p></li>
<li><p>Add TD/PD certifications for nominated drivers (manually)</p>
<ul>
<li><p>Not always clear from either Licences or Administration reports</p></li>
<li><p>Assume initially that &gt;=MR licence is TD, and anyone with RFD but &lt;MR is PD</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Test logins</p>
<ul>
<li><p>tagadmin, kiosk, pager</p></li>
<li><p>Also try one user, with rfsID as password (should prompt to change password)</p></li>
</ul>
</li>
<li><p>Kiosk setup</p>
<ul>
<li><p>Make server visible on network</p>
<ul>
<li><p>On kiosk, add signin.org to /etc/hosts</p></li>
<li><p>On dev system, run on 0.0.0.0, not 1.0.0.127</p></li>
<li><p>On aws, add redirect for wyeept.rfstag.org and wyeept.rfstag.com (shouldn’t be necessary)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Test remote.it</p>
<ul>
<li><p>If possible, connect PI to external network (e.g. SHADOW)</p></li>
<li><p>In <a class="reference external" href="https://app.remote.it/#/devices">remote.it console</a> confirm that device is online, and click VNC to connect with it</p></li>
<li><p>Copy address from connection details (e.g. proxy65.rt3.io:37011) and add a connection in VNC viewer with this address.</p></li>
<li><p>Connect using VNC viewer to confirm connection ok.</p></li>
</ul>
</li>
<li><p>Restart pager server</p>
<ul>
<li><p>Confirm new brigade registered (check journalctl -b | grep page)</p></li>
</ul>
</li>
</ul>
</section>
<section id="setting-up-a-new-kiosk-raspberry-pi">
<span id="pi-setup"></span><h3><span class="section-number">7.1.5. </span>Setting Up a New Kiosk Raspberry PI<a class="headerlink" href="#setting-up-a-new-kiosk-raspberry-pi" title="Permalink to this headline">#</a></h3>
<p>Boot the PI with the NOOBS SD-CARD, and follow the generic instructions in the
<a class="reference external" href="https://www.raspberrypi.com/documentation/computers/getting-started.html#configuration-on-first-boot">Official documentation</a>.</p>
<p>Use the following settings where required:</p>
<figure class="myclass align-default" id="pi-country">
<a class="bg-primary mb-1 reference internal image-reference" href="_images/pi-country.jpg"><img alt="PI Country settingst" class="bg-primary mb-1" src="_images/pi-country.jpg" style="width: 1467px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7.1 </span><span class="caption-text">PI country settings (click to enlarge)</span><a class="headerlink" href="#pi-country" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Password set to this by convention (but can be changed if needed):</p>
<figure class="myclass align-default" id="pi-password">
<a class="bg-primary mb-1 reference internal image-reference" href="_images/pi-password.jpg"><img alt="PI Country settings" class="bg-primary mb-1" src="_images/pi-password.jpg" style="width: 1467px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7.2 </span><span class="caption-text">PI password (click to enlarge)</span><a class="headerlink" href="#pi-password" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Network connections normally via station wifi, but can be hard-wired too. Provide the wifi password, and
it will be remembered for next time.</p>
<figure class="myclass align-default" id="pi-network">
<a class="bg-primary mb-1 reference internal image-reference" href="_images/pi-wifi.jpg"><img alt="PI Network settings" class="bg-primary mb-1" src="_images/pi-wifi.jpg" style="width: 1467px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7.3 </span><span class="caption-text">PI network (click to enlarge)</span><a class="headerlink" href="#pi-network" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Update software - don’t skip this step, but it will take a while.</p>
<p>Configuration settings</p>
<p>In system settings tab, make sure Wait for Network is checked, and change Hostname to the same
name as brigade</p>
<figure class="myclass align-default" id="pi-settings1">
<a class="bg-primary mb-1 reference internal image-reference" href="_images/pi-settings1.jpg"><img alt="PI System settings" class="bg-primary mb-1" src="_images/pi-settings1.jpg" style="width: 1467px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7.4 </span><span class="caption-text">PI System configuration (click to enlarge)</span><a class="headerlink" href="#pi-settings1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>In Interface settings tab, Enable SSH and VNC to allow remote support:</p>
<figure class="myclass align-default" id="pi-settings2">
<a class="bg-primary mb-1 reference internal image-reference" href="_images/pi-settings2.jpg"><img alt="PI Interface settings" class="bg-primary mb-1" src="_images/pi-settings2.jpg" style="width: 1467px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7.5 </span><span class="caption-text">PI interface configuration (click to enlarge)</span><a class="headerlink" href="#pi-settings2" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Final checks</strong></p>
<ul class="simple">
<li><p>Configuration/Display: screen blanking disabled (enabled by default!)</p>
<ul>
<li><p>May be redundant: launch_kiosk turns off screen blanking as well</p></li>
</ul>
</li>
<li><p><em>/boot/config.txt</em> : Comment out #dtoverlay=vc4-fkms-v3d (maybe multiple places)</p></li>
</ul>
<p>Reboot after changing PI configuration when prompted.</p>
</section>
<section id="installing-the-kiosk-software-apt-procedure">
<h3><span class="section-number">7.1.6. </span>Installing the Kiosk Software (apt procedure)<a class="headerlink" href="#installing-the-kiosk-software-apt-procedure" title="Permalink to this headline">#</a></h3>
<p>Kiosk software is now delivered as a package using the APT tool. The package replaces most of the original
installation procedure, and includes the following components:</p>
<ul class="simple">
<li><p>nfcreader program, for reading and writing tags (writetags)</p></li>
<li><p>systemd services to launch the kiosk in a browser (launch_kiosk2) and start the nfcreader (nfcserver2)</p></li>
<li><p>Configuration files for nfcreader and tag reader (udev)</p></li>
<li><p>Unattended upgrades and schedules for automatic updating</p></li>
<li><p>journal set up to maintain long term record</p></li>
</ul>
<section id="initial-preparation">
<h4><span class="section-number">7.1.6.1. </span>Initial Preparation<a class="headerlink" href="#initial-preparation" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Preserve then remove the original installation if needed:</p>
<ul>
<li><p>!! This isn’t needed if updating to a new version. Old files will be automatically removed as part of the update.</p></li>
<li><p>Copy file nfcmanifest2 to the new PI using scp</p>
<ul>
<li><p>scp ~/PycharmProjects/nfcserver/nfcreader/nfcmanifest2 pi&#64;192.168.0.101://home/pi</p></li>
</ul>
</li>
<li><p>Save original installation if needed (this leaves files in place)</p>
<ul>
<li><p>sudo tar -czvf oldnfc.tar.gz <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">nfcmanifest2</span></code></p></li>
<li><p>tar -tvf oldnfc.tar.zip   				# to confirm</p></li>
</ul>
</li>
<li><p>Remove original installation</p>
<ul>
<li><p>cat nfcmanifest2 | sudo xargs rm -rf</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Confirm that the PI hostname is set to the brigade/tenant name and change if needed</p></li>
<li><p>Set up remote access using https://dwservice.net:</p>
<ul>
<li><p>First add a new agent for the PI in server side, and note down access code.</p></li>
<li><p>Make sure new PI has VNC server switched on</p>
<ul>
<li><p>cd /home/ian/PycharmProjects/nfcserver2/tmp/dwservice</p></li>
<li><p>scp dwagent.sh pi&#64;192.168.0.XXX://home/pi</p></li>
<li><p>ssh -v -l pi 192.168.0.XXX</p></li>
<li><p>cd ~</p></li>
<li><p>chmod a+x dwagent.sh</p></li>
<li><p>sudo ./dwagent.sh</p></li>
</ul>
</li>
<li><p>Provide the access code from the server</p></li>
<li><p>Reboot PI, then check that agent appears as available on server.</p></li>
</ul>
</li>
</ul>
</section>
<section id="add-the-rfstag-kiosk-repository-one-off-procedure">
<h4><span class="section-number">7.1.6.2. </span>Add the rfstag-kiosk repository (one-off procedure)<a class="headerlink" href="#add-the-rfstag-kiosk-repository-one-off-procedure" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>In the PI, add the public security key so access is granted:</p>
<ul>
<li><p>cd /tmp</p></li>
<li><p>curl -s –compressed “https://ibowditch.github.io/rfstag-kiosk/KEY.gpg” &gt; KEY.gpg</p></li>
<li><p>cat KEY.gpg | gpg –dearmor | sudo tee /etc/apt/trusted.gpg.d/rfstag.gpg &gt; /dev/null</p></li>
</ul>
</li>
<li><p>Add the rfstag-kiosk repository to the list of available sources:</p>
<ul>
<li><p>sudo curl -s –compressed  “https://ibowditch.github.io/rfstag-kiosk/rfstag.list” &gt; rfstag.list</p></li>
<li><p>sudo cp rfstag.list /etc/apt/sources.list.d</p></li>
<li><p>sudo apt update</p></li>
<li><p>apt list nfcserver2 -a
.</p></li>
<li><p>rm KEY.gpg rfstag.list</p></li>
<li><p>sudo curl -s –compressed -o /etc/apt/sources.list.d/rfstag.list “https://ibowditch.github.io/rfstag-kiosk/rfstag.list”</p></li>
<li><p>sudo apt update</p></li>
<li><p>reboot</p></li>
</ul>
</li>
</ul>
</section>
<section id="pi-display-problems-and-vnc-connections">
<h4><span class="section-number">7.1.6.3. </span>PI display problems and VNC connections<a class="headerlink" href="#pi-display-problems-and-vnc-connections" title="Permalink to this headline">#</a></h4>
<p>Very tricky. Best to copy a working config.txt to the new machine.</p>
<p>If get VNC saying connection not ready, shutdown with monitor connected, then disconnect monitor and restart
While standing on left leg. See notes from 230413 and weep.</p>
</section>
<section id="first-installation">
<h4><span class="section-number">7.1.6.4. </span>First installation<a class="headerlink" href="#first-installation" title="Permalink to this headline">#</a></h4>
<p>Installation is now just:</p>
<ul class="simple">
<li><p>sudo apt update</p></li>
<li><p>sudo apt -y full-upgrade        # to get system up to date</p></li>
<li><p><strong>sudo apt install nfcserver2</strong></p></li>
<li><p>&lt;edit ~/.config/rfstag/local.env to suit&gt;</p></li>
<li><p>reboot (not strictly needed but just to be sure)</p></li>
</ul>
<p>Notes:</p>
<ol class="arabic simple">
<li><p>By default, the package will use the hostname of the PI as the brigade/tenant name, so make sure that is set correctly before installing the package.</p></li>
<li><p>If successful, a browser will start on the kiosk page for the given brigade. Sign in, and save the password.</p></li>
<li><p>In the background, the nfcreader program should also have been launched, and after creating a new event, tags for the brigade should work correctly.</p></li>
<li><p>After the first installation, the package will be automatically updated by unattended-upgrades in the middle of the night.</p></li>
</ol>
<p>Post-install checks</p>
<ol class="arabic simple">
<li><p>Check sound is configured correctly and operates as expected</p></li>
<li><p>Check access to dwservice works as expected using the dwservice phone app.</p></li>
<li><p>Check tag reader operates correctly. Use <strong>journalctl -b | grep nfc</strong> to review logger messages.</p></li>
<li><p>Check services are up and running:</p>
<ul class="simple">
<li><p>systemctl status launch_kiosk2</p></li>
<li><p>systemctl status nfcreader2</p></li>
</ul>
</li>
<li><p>Check that nfc reader can be plugged into other USB ports. The nfcserver2 service should stop when disconnected, and restart automatically whne reconnected. Check the journal for required behavior. This is controlled by file <strong>/etc/udev/rules.d/90-nfcdev.rules</strong></p></li>
</ol>
<p>Further configuration</p>
<p>Basic configuration is controlled by the file <strong>/etc/profile.d/rfstag/base.env</strong>. This should be sufficient in
most cases.</p>
<p>These settings can be overriden if needed, by copying <strong>/home/pi/.config/rfstag/local-example.env</strong> to local.env in the same
directory, then editing local.env as needed.</p>
<p>This can be used to do the following:</p>
<ul class="simple">
<li><p>Change KIOSK_BRIGADE if the hostname is not the brigade name (eg.. multiple kiosks)</p></li>
<li><p>Change KIOSK_LOCATION to a second kiosk name</p></li>
<li><p>Change BUSHFIRE_SERVER to use a test system, eg. rfstag.org, rather than the production server.</p></li>
</ul>
</section>
<section id="update-2024-08-22">
<h4><span class="section-number">7.1.6.5. </span>Update 2024-08-22<a class="headerlink" href="#update-2024-08-22" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Producing kingcreek kiosk</p>
<ul>
<li><p>Latest PI raspian version, included in kit from Core Electronics, is bookworm (version 12)</p></li>
<li><p>All previous releases have been bullseye (V11) or earlier</p></li>
<li><p><strong>nfcserver2 APT package fails to install on bookwork using python 3.11</strong></p></li>
<li><p>Need to rethink delivery strategy, and work out a solution for bookworm and future releases</p>
<ul>
<li><p>Continue with bullseye for now, so not urgent yet</p></li>
</ul>
</li>
<li><p>Downloaded bullseye raspian image and wrote onto SD card using imager on Acer</p></li>
</ul>
</li>
<li><p>latest nfcserver2 version</p>
<ul>
<li><p>Last version on github is 64</p>
<ul>
<li><p>Check using this command</p>
<ul>
<li><p><strong>journalctl | grep KIOSK_VERSION</strong></p></li>
<li><p><strong>grep -i phone /usr/bin/nfc*py</strong></p></li>
</ul>
</li>
</ul>
</li>
<li><p>V64 does not include phone tagging, but V70 does</p></li>
<li><p>Need to install latest version for phone tags</p>
<ul>
<li><p><strong>sudo apt-get install -f /home/pi/tmp/nfcserver2_1.70.0_all.deb</strong></p></li>
</ul>
</li>
<li><p>Check services in /lib/systemd/system/[nfcserver3,launch_kiosk2,kiosk_beeper].service</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="building-the-nfcserver2-package">
<h3><span class="section-number">7.1.7. </span>Building the nfcserver2 package<a class="headerlink" href="#building-the-nfcserver2-package" title="Permalink to this headline">#</a></h3>
<p>ref: https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo/</p>
<p>See /home/ian/PycharmProjects/nfcserver2 for source code. Note that settings from <strong>/etc/apt/apt.conf.d/rfstag.conf</strong> are used when building the package.</p>
<p>Key areas:</p>
<ul class="simple">
<li><p>debian</p>
<ul>
<li><p>contains configuration files for the package, the most significant of which are:</p>
<ul>
<li><p>changelog: needs to be updated with every release. Can be done manually or using dch</p></li>
<li><p>install: lists all files included in the package, and where they need to go on the target machine</p></li>
<li><p>pre/postinst: pre and post installation procedures</p></li>
<li><p>rules: basic makefile template</p></li>
</ul>
</li>
</ul>
</li>
<li><p>conf</p>
<ul>
<li><p>Include configuration files for</p>
<ul>
<li><p>APT (02periodic, 51unattended-upgrades)</p></li>
<li><p>udev (90-nfcdev.rules) to launch service when nfc device connected</p></li>
<li><p>base/local.env: rfstag kiosk configuration</p></li>
<li><p>msmtprc: email server configuration</p></li>
</ul>
</li>
</ul>
</li>
<li><p>src</p>
<ul>
<li><p>top level scripts, installed in /usr/bin, some called from service file</p></li>
</ul>
</li>
<li><p>systemd</p>
<ul>
<li><p>launch_kiosk2.service</p>
<ul>
<li><p>starts a browser at the kiosk page for the brigade</p></li>
<li><p>Depends on network, and will restart if fails</p></li>
</ul>
</li>
<li><p>nfserver2.service</p>
<ul>
<li><p>Runs tag reader in background</p></li>
<li><p>Launched on startup</p></li>
<li><p>Stopped if reader disconnected, restarted when reconnected</p></li>
<li><p>Requires alsa sound system to function for beeps (might not be ready first time on restart, but will retry).</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>A new deb file is built using the <strong>buildeb</strong> script. It is named after the version number,
eg. nfcserver2_1.42.0_all.deb, and is placed in the ~/PycharmProjects directory.</p>
<p>The deb file can be tested by scp’ing to a test PI, then <strong>sudo apt install /home/pi/nfcserver2_1.42.0_all.deb</strong></p>
<p>NB: .deb filename must be spelled out in full - no wildcards.</p>
<p>ref: https://assafmo.github.io/2019/05/02/ppa-repo-hosted-on-github.html</p>
<p>Once it is ok, it can be placed on the github repository as follows:</p>
<ul class="simple">
<li><p>cd ~/rfstag-kiosk</p></li>
<li><p>cp ~/Pyc*/<em>42</em>.deb .</p></li>
<li><p>./rebuild</p></li>
</ul>
<p>This will send the new .deb file to the github repository, and it will be available for download by clients after a few minutes.</p>
<p>rfstag kiosks are set to check for updates each night, and unattended-upgrades will automatically download and install kiosk updates.</p>
</section>
<section id="on-screen-keyboard">
<h3><span class="section-number">7.1.8. </span>On screen keyboard<a class="headerlink" href="#on-screen-keyboard" title="Permalink to this headline">#</a></h3>
<p>Normally, a USB keyboard and mouse are connected to the Raspberry PI to allow normal interaction with the Kiosk.</p>
<p>If required, the USB keyboard can be replaced with an on-screen keyboard, similar to those used on mobile phones.</p>
<p>There are several options available: see <a class="reference external" href="https://www.industrialshields.com/blog/raspberry-pi-for-industry-26/post/top-3-on-screen-virtual-keyboards-for-raspberry-plc-panel-pc-401">3 options</a> here.</p>
<p><a class="reference external" href="https://manpages.ubuntu.com/manpages/bionic/man1/onboard.1.html">onboard</a> has been tested and used by one brigade.</p>
<p>To make sure the keyboard is visible while running the kiosk:</p>
<ul class="simple">
<li><p>echo “SCREEN_KEYBOARD=/usr/bin/onboard” &gt;&gt; ~/.config/rfstag/local.env</p></li>
</ul>
<p>Should be able to replace <strong>onboard</strong> with any other keyboard in the above, but not tested.</p>
<section id="running-the-activ-dashboard-on-the-pi">
<h4><span class="section-number">7.1.8.1. </span>Running the ACTIV dashboard on the PI<a class="headerlink" href="#running-the-activ-dashboard-on-the-pi" title="Permalink to this headline">#</a></h4>
<p>The latest Raspberry PI 4B has 2 HDMI sockets, so a second screen can be attached. If needed, this can be used
to display the ACTIV dashboard, as well as run the normal sign-in Kiosk.</p>
<p>Will need a second HDMI cable with micro-HDMI connection: get from <a class="reference external" href="https://core-electronics.com.au/raspberry-pi-micro-hdmi-to-standard-hdmi-1m-cable.html">Core Electronics</a>.</p>
<p>With a second monitor attached, type <strong>launch_activ</strong> on a command line.</p>
<p>Files:</p>
<ul class="simple">
<li><p>/etc/profile.d/rfstag/base.env</p>
<ul>
<li><p>Offset of second screen set with HDMI2_X_OFFSET=1920</p></li>
<li><p>Overwrite in /home/pi/.config/rfstag/local.env if needed</p></li>
<li><p>Depends on resolution of the first monitor.</p></li>
</ul>
</li>
<li><p>/usr/bin/launch_activ</p>
<ul>
<li><p>Uses default of 1920 if HDMI2_X_OFFSET not set.</p></li>
<li><p>sudo systemctl start</p></li>
</ul>
</li>
<li><p>/lib/systemd/system/launch_activ</p>
<ul>
<li><p>sudo systemctl start launch_activ to set ok</p></li>
<li><p>enable if ok, so starts at reboot</p></li>
</ul>
</li>
<li><p>/home/pi/Documents/Profiles/1</p>
<ul>
<li><p>Need to define a second profile for the second screen, separate from kiosk</p></li>
<li><p>set this in env file: ACTIV_CHROME_PROFILE=/home/pi/Documents/Profiles/1</p></li>
</ul>
</li>
<li><p>Launch page will initially require login</p>
<ul>
<li><p>Use brigades dashboard login and password</p></li>
<li><p>Remember credentials</p></li>
</ul>
</li>
</ul>
<p>230412: As of this date, the second ACTIV screen config has some problems.</p>
<p>It works, but there are lots of warnings and errors logged in the journal, probably related to having 2 independent
chromium browsers running in parallel.
launch_kiosk2 files have been updated to remove ACTIV and a seocnd screen until this is fixed properly.
ACTIV support has not been released, and is not generally available at present, and it should stay that way until
further investigations are completed.
NB: Further journal messages are still being generated unless dtoverlay=vc4-fkms-v3d is commented out of /boot/config.txt.
This file can’t be included in the APT package, so will require a manual check on each kiosk to ensure it is disabled.
These messages seem benign, but better to remove source if possible.</p>
</section>
</section>
<section id="installing-the-kiosk-software-original-procedure">
<h3><span class="section-number">7.1.9. </span>Installing the Kiosk Software (original procedure)<a class="headerlink" href="#installing-the-kiosk-software-original-procedure" title="Permalink to this headline">#</a></h3>
<p>Copy the installation package from a thumb drive into folder /home/pi, or use (in tpad shell, not pycharm):</p>
<ul class="simple">
<li><p>cd /home/ian/PycharmProjects/nfcserver</p></li>
<li><p>makeself –notemp nfcreader nfcreader220920f.sh bushfire ./nfcinstall</p></li>
<li><p>scp /home/ian/PycharmProjects/nfcserver/nfcreader220920f.sh pi&#64;192.168.0.226://home/pi</p></li>
</ul>
<p>Open a command Terminal (top menu bar - black box).</p>
<p>Run the installation procedure as follows:</p>
<p>./nfcreader220920f.sh</p>
<p>This can take some time, as it will update the system software.</p>
<p>The installation procedure will do the following:</p>
<ul class="simple">
<li><p>Set the Brigade the kiosk will use (when prompted)</p>
<ul>
<li><p>A server of this name must exist, or the given name will not be accepted.</p></li>
<li><p>The nfcreader.ini file will be updated with the given validated Brigade name.</p></li>
</ul>
</li>
<li><p>Install sound files (for beeps and buzzes)</p></li>
<li><p>Install python libraries for sound and nfc support.</p></li>
<li><p>Remove unwanted, large packages to free disk space (e.g. libreoffice, games, wolfram,… )</p></li>
<li><p>Add kiosk software to /usr/local/bin</p></li>
<li><p>Set boot script in /home/pi/.config/lxsession/LXDE-pi/autostart</p></li>
<li><p>Register the Sony nfc reader</p></li>
<li><p>Register and start the nfcserver service, used to read nfc tags.</p></li>
<li><p>Set up unattended upgrades to keep the system up to date automatically.</p></li>
<li><p>Set up remote.it to enable remote support</p></li>
</ul>
<p>Then reboot when finished.</p>
<p>Then test nfc using:</p>
<p>python3 -m nfc</p>
<p>If there’s an error (likely), you’ll need to type the following commands to clear the error, then reboot again:</p>
<p>sh -c ‘echo SUBSYSTEM==”usb”, ACTION==”add”, ATTRS{idVendor}==”054c”, ATTRS{idProduct}==”06c3”, GROUP=”plugdev” &gt;&gt; /etc/udev/rules.d/nfcdev.rules’
udevadm control -R</p>
</section>
<section id="first-login">
<h3><span class="section-number">7.1.10. </span>First login<a class="headerlink" href="#first-login" title="Permalink to this headline">#</a></h3>
<p>If all is set up correctly, the first screen shown after reboot should be as follows. Login using
kiosk user.</p>
<figure class="myclass align-default" id="pi-firstlogin">
<a class="bg-primary mb-1 reference internal image-reference" href="_images/pi-firstlogin.jpg"><img alt="PI first login" class="bg-primary mb-1" src="_images/pi-firstlogin.jpg" style="width: 1467px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7.6 </span><span class="caption-text">PI first login (click to enlarge)</span><a class="headerlink" href="#pi-firstlogin" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>You will be prompted to Save Password - click Save to do this (IMPORTANT).</p>
</section>
<section id="check-remote-it">
<h3><span class="section-number">7.1.11. </span>Check remote.it<a class="headerlink" href="#check-remote-it" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Go to https://app.remote.it/#/devices</p>
<ul>
<li><p>Login as ibowditch on google acocunt</p></li>
</ul>
</li>
<li><p>Check new device is listed in available devices</p>
<ul>
<li><p>NB: Only 5 available under free account. Will need paid account if need to exceed this</p></li>
</ul>
</li>
<li><p>Connect to new device by clicking on  device, then VNC under Service on LHS</p>
<ul>
<li><p>Once connected, copy url and make new VNC connections on realVNC</p></li>
<li><p>Connect with this and check access is ok</p></li>
</ul>
</li>
</ul>
</section>
<section id="testing">
<h3><span class="section-number">7.1.12. </span>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">#</a></h3>
</section>
<section id="full-deployment-to-prd">
<h3><span class="section-number">7.1.13. </span>Full Deployment to PRD<a class="headerlink" href="#full-deployment-to-prd" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Update Platform to latest version in AWS console</p>
<ul>
<li><p>Do this on test env first to ensure nothing breaks</p>
<ul>
<li><p>If OK, also do on PRD, indepndent of code changes</p></li>
</ul>
</li>
<li><p>Don’t mix OS upgrade with code changes</p></li>
<li><p>Hard to undo this, and if fails, difficult to fall back</p>
<ul>
<li><p>Set OS back to original level in AWS console, and wait for recovery</p></li>
</ul>
</li>
<li><p>Check main site deployed ok and works with new Platform before proceeding</p></li>
</ul>
</li>
<li><p>Check AWS Health checks: Load Balancer Configuration
Name		  Port	Protocol	HTTP code	Health check path	Stickiness
default 	  80	HTTP		200		    /indexawsmt		    disabled
http 		  80	HTTP		200		    /indexawsmthttps	disabled
websocket 5000	HTTP		200		    /indexawsmtws	    enabled</p></li>
<li><p>Double check all changes since last prd deployment</p>
<ul>
<li><p>Get last deployment datetime from Running Version, at
https://ap-southeast-2.console.aws.amazon.com/elasticbeanstalk/home?region=ap-southeast-2#/environment/dashboard?applicationName=bushfire2&amp;environmentId=e-mccptfvpnq</p></li>
</ul>
</li>
<li><p>Make backups</p>
<ul>
<li><p>AWS configurations for both tst6 and prd (AWS Console: Actions/Save Configuration)</p></li>
<li><p>RDS in pgadmin for tst6 and prd: connect to AWS RDS from dev system</p></li>
<li><p>Snapshot for RDS for tst6 and prd:</p>
<ul>
<li><p>See https://ap-southeast-2.console.aws.amazon.com/rds/home?region=ap-southeast-2#databases:</p></li>
<li><p>Actions/Take Snapshot</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Set .ebextensions/02_python.config for PRD,</p>
<ul>
<li><p>Comment out # Test settings: bushfire2-tst6</p></li>
<li><p>Uncomment:</p></li>
<li><p>Production settings: bushfire2-prd</p>
<ul>
<li><p>“SECRET_KEY”:  “………………”</p></li>
<li><p>“RDS_HOSTNAME”: “bushfire2-prd-rds2.c5b4rv0axnji.ap-southeast-2.rds.amazonaws.com”</p></li>
<li><p>“REDIS_SERVER”: “bushfire2-prd.pgfstu.0001.apse2.cache.amazonaws.com”</p></li>
<li><p>“AWS_STORAGE_BUCKET_NAME”: “bushfire2-prd”</p></li>
<li><p>“AWS_ACCESS_KEY_ID”: “…………..”</p></li>
<li><p>“AWS_SECRET_ACCESS_KEY”: “…………….”</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Deploy from pycharm terminal:</p>
<ul>
<li><p>eb deploy bushfire2-prd –timeout 30</p></li>
</ul>
</li>
<li><p>Check server logs and emails for any signs of failure</p>
<ul>
<li><p>New migrations might cause some messages while in transition, but check errors carefully in case</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="create-new-elasticache-on-aws">
<h2><span class="section-number">7.2. </span>Create new Elasticache on AWS<a class="headerlink" href="#create-new-elasticache-on-aws" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Start at https://ap-southeast-2.console.aws.amazon.com/elasticache/home?region=ap-southeast-2#/redis</p></li>
<li><p>Configure and Create New cluster</p></li>
<li><p>Cluster Mode: Disabled</p></li>
<li><p>Provide cluster name</p></li>
<li><p>Location: AWS Cloud</p></li>
<li><p>Node type: cache.t2.micro</p></li>
<li><p>Port:  6379 (default)</p></li>
<li><p>Replicas: 0 (switches off Multi-AZ)</p></li>
<li><p>Subnet group: bushfire2-prd-ec-sng (vpc-f4221493)</p></li>
<li><p>Encryption: Off</p></li>
<li><p>Security group: sg-bbc0cbc4 (default)</p></li>
<li><p>Backup enabled - 1 Day</p></li>
<li><p>No logs</p></li>
<li><p>Shards: shows 1 for latest redis (6.2.6), 0 otherwise, even if Cluster Mode==Off</p></li>
<li><p>Add to 02_python.conf in deployment settings</p></li>
</ul>
</section>
<section id="rds">
<h2><span class="section-number">7.3. </span>RDS<a class="headerlink" href="#rds" title="Permalink to this headline">#</a></h2>
<section id="copy-prd-rds-to-dev-env">
<h3><span class="section-number">7.3.1. </span>Copy prd RDS to dev env<a class="headerlink" href="#copy-prd-rds-to-dev-env" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Check access available to AWS RDS</p>
<ul>
<li><p>Select RDS DB instance from https://ap-southeast-2.console.aws.amazon.com/rds/home?region=ap-southeast-2#databases:</p></li>
<li><p>Select VPC Security Group : normally default (sg-bbc0cbc4)</p></li>
<li><p>Click Edit Inbound Rules</p>
<ul>
<li><p>Update inbound rule for buckraYYMMDD</p></li>
<li><p>Click Source=Custom, and select My IP - this will update home IP if changed.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Open pgadmin on dev machine</p>
<ul>
<li><p>Make backup of current prd RDS on AWS</p>
<ul>
<li><p>Select and open AWS prd server - currently bushfire2-prd2-rds2</p></li>
<li><p>Right click Database ebdb and select Backup</p></li>
<li><p>Provide filename for backup - eg. /home/ian/kbfb/aws-backups/bushfire2-prd-rds-220916</p>
<ul>
<li><p>Format=Custom</p></li>
<li><p>Role Name=ian</p></li>
</ul>
</li>
<li><p>Click Backup</p></li>
</ul>
</li>
<li><p>Restore AWS prd backup to local database</p>
<ul>
<li><p>Make new database under server Thinkpad (dev machine), named eg. bushfire2-prd-220916</p></li>
<li><p>Right click new local RDS and then Restore</p>
<ul>
<li><p>Provide name of AWS prd backup file</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Prepare for use in dev env</p>
<ul>
<li><p>Run management command to localise local RDS to dev env (not really necessary)</p>
<ul>
<li><p>python manage.py set_tenant_domains</p></li>
<li><p>NB: This only really necessary for prd or tst environments on AWS</p>
<ul>
<li><p>Local dev env should still be listed as a valid domain, even if not Primary</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Point dev env to new RDS</p>
<ul>
<li><p>Edit bushfire/settings/.env</p></li>
<li><p>Set RDS_DB_NAME=bushfire2-prd2-220916  (for example)</p></li>
</ul>
</li>
<li><p>Run local app and confirm latest RDS in use</p></li>
</ul>
</li>
</ul>
</section>
<section id="updating-models-migrations">
<h3><span class="section-number">7.3.2. </span>Updating Models/Migrations<a class="headerlink" href="#updating-models-migrations" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>On dev system, run the following in a Pycharm terminal:</p>
<ul>
<li><p>python manage.py makemigrations</p></li>
<li><p>python manage.py migrate_schemas</p></li>
</ul>
</li>
<li><p>Then check for any new files under migrations folder in each module, and add them to git.</p></li>
<li><p>Next deployment will run migrate_schemas, and will include the changes providing the new migrations file is in git.</p></li>
</ul>
</section>
</section>
<section id="aws-credits-annual">
<h2><span class="section-number">7.4. </span>AWS Credits (annual)<a class="headerlink" href="#aws-credits-annual" title="Permalink to this headline">#</a></h2>
<p>For Ku-ring-gai:</p>
<ul class="simple">
<li><p>Login to https://www.connectingup.org/ as user admin&#64;kbfb.org.au (use saved password)</p></li>
<li><p>Search for AWS</p></li>
<li><p>Order the Amazon Web Services Credits for Nonprofits - was $136 + GST</p></li>
<li><p>Complete order and pay with own card</p></li>
</ul>
<p>Then redeem credits on AWS Credits page:</p>
<ul class="simple">
<li><p>https://us-east-1.console.aws.amazon.com/billing/home?region=ap-southeast-2#/credits</p></li>
<li><p>logging in with account:</p>
<ul>
<li><p>Account Id: 373346640794</p></li>
<li><p>Seller: Amazon Web Services Australia Pty Ltd</p></li>
<li><p>Account Name: Ku-ring-gai Bush Fire Brigade</p></li>
<li><p>Password: *****</p></li>
</ul>
</li>
</ul>
</section>
<section id="updating-userdocs">
<h2><span class="section-number">7.5. </span>Updating userdocs<a class="headerlink" href="#updating-userdocs" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Make any necessary updates and check ok on local version http://127.0.0.1:5500/index.html</p>
<ul>
<li><p>First do make clean html</p></li>
</ul>
</li>
<li><p>Save any changes into git using Commit on top level userdocs directory</p>
<ul>
<li><p>Do NOT Commit and Push until next steps are completed</p></li>
</ul>
</li>
<li><p>Remove Internal section by editing this line in conf.py</p>
<ul>
<li><p>Use this to keep internal documentation private. Comment out for local use.</p></li>
<li><p>exclude_patterns += [‘internal*’]</p></li>
<li><p>Repeat make clean html</p></li>
</ul>
</li>
<li><p>Check Internal section not visible on dev machine</p></li>
<li><p>Save in Git</p>
<ul>
<li><p>ghp-import -n -p -f _build/html</p>
<ul>
<li><p>NB: will need latest GIT token as password: see https://github.com/settings/tokens</p></li>
<li><p>Use the google authenticator app to get access when prompted.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Commit and Push whole thing</p>
<ul>
<li><p>This will update both git version at https://ibowditch.github.io/userdocs
and reference version at https://rfstag-user.netlify.app/index.html</p></li>
</ul>
</li>
</ul>
</section>
<section id="adding-a-new-pager-sub-system">
<h2><span class="section-number">7.6. </span>Adding a New Pager Sub-system<a class="headerlink" href="#adding-a-new-pager-sub-system" title="Permalink to this headline">#</a></h2>
<p>Pager messages are monitored using a Raspberry PI, with an RTL-SDR (Software Defined Radio) USB dongle
set to receive messages broadcast on the RFS Pager frequency (see <a class="reference external" href="https://www.rtl-sdr.com/rtl-sdr-tutorial-pocsag-pager-decoding/">https://www.rtl-sdr.com/rtl-sdr-tutorial-pocsag-pager-decoding/</a>.</p>
<p>Received messages are checked, and if one contains an Incident Call for a customer of rfstag, the pager sub-system
will send a request to the rfstag server to create a new event for the brigade, so that responding members can
sign-in immediately without having to first create a new event.</p>
<p>The new event has the pager message as the title, the activity type as Incident-Fire, and the OIC as the callout
Officer or SDC. The event start time is the time of the pager call, and the end time is 3 hours later.</p>
<p>Pager message transmissions are strong, but a single receiver can’t cover all of NSW, so additional
listening stations are needed if a brigade’s pager signals can not be received in Sydney.</p>
<p>These instructions show how to set up an additional pager listening station in another region.</p>
<ul class="simple">
<li><p>Obtain and set up a Raspberry PI 3B in the  <a class="reference internal" href="#pi-setup"><span class="std std-ref">same way as for a kiosk</span></a></p></li>
<li><p>Obtain an RTL-SDR and setup according to supplier instructions,
with a dipole antenna. see <a class="reference external" href="https://secomms.com.au/product/rtl-sdr-r820t2-rtl2832u-software-defined-radio-dipole-antenna-kit/">https://secomms.com.au/product/rtl-sdr-r820t2-rtl2832u-software-defined-radio-dipole-antenna-kit/</a></p>
<ul>
<li><p>No need to install software or dependencies, just get the hardware set up.</p></li>
<li><p>Setup the dipole antenna to roughly 1m span, vertically aligned.</p></li>
</ul>
</li>
<li><p>If necessary, generate a self-extracting installation script for the latest pager software
by running the following command in a linux shell:</p>
<ul>
<li><p><strong>cd ~/Pycharmprojects/nfcserver</strong></p></li>
<li><p><strong>makeself –notemp ./pager pager220928.sh fred ./pagerinstall</strong></p></li>
</ul>
</li>
<li><p>Copy the self-extracting installation script to the target PI:</p>
<ul>
<li><p><strong>scp pager2220928.sh pi&#64;192.168.0.59://home/pi</strong></p></li>
</ul>
</li>
<li><p>VNC or ssh to the target pi, and run the self-extracting installer in a linux shell:</p>
<ul>
<li><p><strong>./pager220928.sh</strong></p></li>
</ul>
</li>
<li><p>This will do the following:</p>
<ul>
<li><p>Create a new working directory ~/pager</p></li>
<li><p>Backup existing files using the <strong>pagermanifest</strong> file as a guide</p></li>
<li><p>Copy the pager.ini file to ~</p></li>
<li><p>Install the necessary SDR software using <strong>sdrinstall.sh</strong></p>
<ul>
<li><p>Install all dependencies, and then download and build the following:</p>
<ul>
<li><p><strong>rtl_fm</strong></p>
<ul>
<li><p>Used to tune the RTL-SDR dongle, and receive messages on the RFS pager frequency</p></li>
</ul>
</li>
<li><p><strong>multimon-ng</strong></p>
<ul>
<li><p>Used to decode messages from rtl_fm into text</p></li>
<li><p>page_to_journal.sh then passes these on to page_to_journal</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Copy these programs to /usr/local/bin for general use</p></li>
</ul>
</li>
<li><p>Install all python modules, using <strong>requirements.txt</strong> as a guide</p></li>
<li><p>Remove large, unnecessary apps (wolfram, office, games, etc.)</p></li>
<li><p>Copy main scripts into place at /usr/local/bin:</p>
<ul>
<li><p><strong>page_to_journal</strong>.[py,sh]</p>
<ul>
<li><p>Logs all received pager messages to system journal</p></li>
</ul>
</li>
<li><p><strong>pager_relay</strong>.[py,sh]</p>
<ul>
<li><p>Forwards messages to pushover, compressing adjacent identical messages, using cc:</p></li>
<li><p>Creates incidents on rfstag when needed for rfstag customers.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Installs system services in <strong>/lib/systemd/system</strong></p>
<ul>
<li><p>Main scripts are then launched on system startup</p></li>
</ul>
</li>
<li><p>Installs automated <strong>unattended-upgrades</strong> and email notification using <strong>msmtp</strong></p></li>
<li><p>Installs <strong>remote.it</strong> client to allow remote access</p></li>
</ul>
</li>
<li><p>Reboot, and run the following checks:</p>
<ul>
<li><p>Check main scripts are running correctly:</p>
<ul>
<li><p><strong>sudo systemctl status page_to_journal</strong></p></li>
<li><p><strong>sudo systemctl status pager_relay</strong></p></li>
</ul>
</li>
<li><p>Monitor system journal for pager messages with:</p>
<ul>
<li><p><strong>journalctl -f | grep page</strong></p></li>
<li><p>This will show pager messages as they are received</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Important pager.ini settings</p>
<ul>
<li><p>BUSHFIRE_SERVER = rfstag.com</p></li>
<li><p>PAGER_REGION = sydney</p></li>
</ul>
</li>
<li><p>Operational Notes</p>
<ul>
<li><p>Capcodes are downloaded from the rfstag server using public url rfstag.com/capcodes</p></li>
<li><p>Brigades using rfstag in this PAGER_REGION are downloaded using public url rfstag.com/brigades/{PAGER_REGION}</p></li>
<li><p>Automated updates are available (not yet fully implemented) using public url rfstag.com/update/pager</p></li>
</ul>
</li>
</ul>
</section>
<section id="pi-won-t-boot">
<h2><span class="section-number">7.7. </span>PI won’t boot<a class="headerlink" href="#pi-won-t-boot" title="Permalink to this headline">#</a></h2>
<p>If nothing is shown on the screen, and the PI LED is solid red, it’s likely that the SD card is corrupted. This
prevents the PI from booting up, as it can’t read the operating system from the SD card.</p>
<p>SD card corruption can be caused by wear and tear, extensive long term usage (read/writes), or by incorrect
shutdown procedures. Always shutdown the PI properly (ctrl-alt-del, then shutdown) rather than just powering off.</p>
<p>To replace the SD card, you need to:</p>
<ol class="arabic simple">
<li><p>Purchase a new SD card</p></li>
</ol>
<ul class="simple">
<li><p>32Gb recommended</p></li>
<li><p>Recommended models at https://www.tomshardware.com/best-picks/raspberry-pi-microsd-cards</p></li>
<li><p>Recommended to buy pre-loaded SD card: 32GB MicroSD Card with NOOBS for all Raspberry Pi Boards
see https://core-electronics.com.au/32gb-microsd-card-with-noobs-for-all-raspberry-pi-boards.html?gclid=CjwKCAiAk–dBhABEiwAchIwkeJNDdNBnoeqsqydU7FNzhWiyUOdbMh0WV1al7JQ1KDvvGrV-bEEfhoCt9kQAvD_BwE</p></li>
<li></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>Image</p></li>
</ol>
<p>For a raw card, follow the procedure at https://www.raspberrypi.com/software/ to load the new SD card with the
Raspberry O/S.</p>
<ol class="arabic simple" start="3">
<li><p>Now set up the PI from scratch using the procedure above.</p></li>
</ol>
</section>
</section>
<section id="aws-deployment">
<h1><span class="section-number">8. </span>AWS Deployment<a class="headerlink" href="#aws-deployment" title="Permalink to this headline">#</a></h1>
<p>The django web application for RFStag can be run on a PC, using an IDE like pycharm. It works fine like this, and is
very useful for developing and debugging code, but at some point it needs to be deployed to an external server so that
brigades and members can connect to it and use it.</p>
<p>The django web application requires the following resources to run properly:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#internal#relational-database-postgres-rds"><span class="xref myst"><strong>Relational database</strong></span></a> (postgres) - to store all the brigade models and data</p></li>
<li><p><a class="reference internal" href="#cache-redis-elasticache"><span class="xref myst"><strong>Cache</strong></span></a> - to improve response times and manage django channels (server sent events)</p></li>
<li><p><a class="reference internal" href="#static-file-storage-s3-bucket"><span class="xref myst"><strong>Static file storage</strong></span></a> - to store js, css, images, and other artifacts</p></li>
<li><p><a class="reference internal" href="#logging-rotating-linux-logs"><span class="xref myst"><strong>Logging</strong></span></a> - to record activity and assist in diagnosis of problems and debugging</p></li>
<li><p><a class="reference internal" href="#ip-routing-route-53-hosted-zones"><span class="xref myst"><strong>IP routing</strong></span></a> - to route traffic to the web application domain</p></li>
<li><p><a class="reference internal" href="#ssl-certification-aws-certificate-manager"><span class="xref myst"><strong>SSL certification</strong></span></a> - to enable secure connections</p></li>
<li><p><a class="reference internal" href="#processor-disc-and-memory-elastic-beanstalk"><span class="xref myst"><strong>Processor, disc and memory</strong></span></a> - to run the web application</p></li>
</ol>
<p>Some of these are optional when running in a development environment, but all are mandatory when running in a public
server.</p>
<p>Early in the development process, I selected <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html">AWS Elastic Beanstalk</a>
as the hosting platform for the RFStag application, for the following reasons:</p>
<p>a. Widely used and adopted in the industry</p>
<p>b. Provides scalability, stability, reliability, and good performance</p>
<p>c. Expensive, but non-profit grants available for credits</p>
<p>d. Good support for django prerequisites, including linux, python and postgres</p>
<p>e. Support for django channels (unavailable in most environments 5 years ago)</p>
<p>f. Extensive documentation both from AWS and in stackoverflow</p>
<p>g. Support provided (at a fee)</p>
<p>That said, it was still an enormous learning curve to go from basic deployment to reliable and repeatable devops.</p>
<section id="aws-deployment-checklist">
<h2><span class="section-number">8.1. </span>AWS Deployment Checklist<a class="headerlink" href="#aws-deployment-checklist" title="Permalink to this headline">#</a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#aws-resources"><span class="xref myst">Set up the required AWS resources</span></a></p></li>
<li><p><a class="reference internal" href="#github-actions-secrets-and-variables"><span class="xref myst">Set up a github actions environment</span></a> with the required values</p></li>
<li><p><a class="reference internal" href="#processor-disc-and-memory-elastic-beanstalk"><span class="xref myst">Create a new AWS EB environment</span></a></p></li>
<li><p><a class="reference internal" href="#deploying-to-aws-eb-with-github-actions"><span class="xref myst">Deploy to the AWS WEB environment via github actions</span></a></p></li>
</ol>
</section>
<section id="settings-for-web-application-deployment">
<h2><span class="section-number">8.2. </span>Settings for Web Application Deployment<a class="headerlink" href="#settings-for-web-application-deployment" title="Permalink to this headline">#</a></h2>
<p>Deployment to a hosting environment like AWS is a complex process, and requires a clear specification of the environment
in which the web application is to run. The locations and configuration of all the resources needs to be well specified,
and defined in a way that can be easily and unambiguously verified.</p>
<p>Details of how the resources required for RFStag will be specified in later sections. First, let’s cover the methods
used to specify django settings.</p>
<section id="django-settings">
<h3><span class="section-number">8.2.1. </span>Django Settings<a class="headerlink" href="#django-settings" title="Permalink to this headline">#</a></h3>
<p>One of the first things that django does when a web application is started is to read the settings to be used by the application.
These settings are normally specified using the environment variable <a class="reference external" href="https://docs.djangoproject.com/en/5.0/topics/settings/#django-settings">DJANGO_SETTINGS_MODULE</a>. For example in the pycharm
run configuration kbfb2, <strong>DJANGO_SETTINGS_MODULE=bushfire.settings.local</strong>.</p>
<p>Project folder <strong>bushfire</strong> has a sub-directory called <strong>settings</strong> which contains the following configuration files</p>
<ul class="simple">
<li><p><strong>base.py</strong> - basic configuration used in all environments using <strong>from bushfire.settings.base import</strong> *</p></li>
<li><p><strong>local.py</strong> - used in local development environment</p></li>
<li><p><strong>awseb.py</strong> - used in AWS Elastic Beanstalk environment</p></li>
</ul>
<p>These are python files that define variables used by django. Rather than having a different django settings file for every
single type of deployment, e.g. test, production, staging, etc., it is better to obtain some django settings from the
external environment, using environment variables.</p>
</section>
<section id="environment-variables-as-settings">
<h3><span class="section-number">8.2.2. </span>Environment Variables as settings<a class="headerlink" href="#environment-variables-as-settings" title="Permalink to this headline">#</a></h3>
<p>Using the python package <a class="reference external" href="https://django-environ.readthedocs.io/en/latest/#welcome-to-django-environ-documentation">django-environ</a>,
it is possible to feed operating system environment variables into the django settings to give greater control over the
run time environment (see <a class="reference external" href="https://www.12factor.net/">Twelve-factor methodology</a> for more details).</p>
<p>For example, this allows us to define the location of the database to be used by the django web application as <strong>env(‘RDS_HOSTNAME’)</strong>,
and this is used in the <strong>DATABASES</strong> setting in base.py. This avoids hard-coding environmental values into configuration files,
and gives us the flexibility to change the operating environment without updating any code - just change an environment
variable and restart the web application.</p>
<p>As well as the database values, we can also define the location of the other resources listed above (e.g. cache, logging, etc.)
in terms of environment variables, so that only these environment values have to be changed when we need to update the
cache or other operations, and no code changes are needed.</p>
<section id="django-setting-allowed-hosts">
<h4><span class="section-number">8.2.2.1. </span>Django Setting ALLOWED_HOSTS<a class="headerlink" href="#django-setting-allowed-hosts" title="Permalink to this headline">#</a></h4>
<p>It is critical that ALLOWED_HOSTS is set correctly when running on AWS, otherwise normal requests will cause the web
app to crash with a 500 error.</p>
<p><strong>django-tenants</strong> middleware checks ALLOWED_HOSTS while trying to determine the tenant to route the request to. If the
host in the request is not included in ALLOWED_HOSTS, django-tenants will fail, and this exception will percolate up
as a 500 error.</p>
<p><strong>bushfire/settings/awseb.py</strong> has an elaborate scheme to calculate ALLOWED_HOSTS using a variety of environment settings
and AWS functions. It seems to work for now, but that may change.</p>
</section>
<section id="development-environment-variables">
<h4><span class="section-number">8.2.2.2. </span>Development Environment Variables<a class="headerlink" href="#development-environment-variables" title="Permalink to this headline">#</a></h4>
<p>Environment variables for the development environment are defined in the file <strong>bushfire/.env.local</strong>, and this follows a
naming convention of specifying the environment using the suffix in <strong>DJANGO_SETTINGS_MODULE</strong>, which for the development
environment is “local” (from bushfire.settings.local).</p>
<p>The development environment is fully defined in <strong>bushfire/.env.local</strong>, and it must contain all the values required
to run the web application. These can be changed, for example we can use a database on AWS rather than a local database,
just by changing these settings in this file.</p>
</section>
<section id="deployment-environment-variables">
<h4><span class="section-number">8.2.2.3. </span>Deployment Environment Variables<a class="headerlink" href="#deployment-environment-variables" title="Permalink to this headline">#</a></h4>
<p>Deployment to AWS is complex, and requires fine control over the environment variables to be used by the hosted web application.</p>
<p>In general, there are 2 distinct environments used on AWS - one for production, and one for staging/testing.</p>
<p>Some resources such as cache can be shared across environments (to reduce hosting costs), but others such as the RDS must
be kept separate to minimise risk to production systems.</p>
<p>In early 2024, after a number of battles with AWS deployment, I decided to adopt a continuous integration and
deployment (CI/CD) approach to AWS deployment, and settled on <a class="reference external" href="https://docs.github.com/en/actions">github actions</a> as the tool to use for this.
This gives fine control over deployment and implements CI/CD.</p>
<p>A full description of github actions usage is given <a class="reference internal" href="#deploying-to-aws-eb-with-github-actions"><span class="xref myst">below</span></a>,
but a key part is the definition of variables and secrets, sets of which must be defined for different deployment types.</p>
<p>Github action <strong>variables</strong> are used to define the environment variables passed to AWS during the deployment process.
These values can be seen on AWS in the Elastic Beanstalk Environment Configuration page, but they are stored on github,
and transferred to AWS as part of the deployment process (see awseb.yml). So any environment changes need to be made on github, then
a new deployment made to implement the changes.</p>
<p>Githib action <strong>secrets</strong> are used for confidential information such as <strong>RDS_PASSWORD</strong>. These are encrypted and can’t be
read in github (or anywhere else - except AWS EB configuration) after they are set.</p>
<p>Github variables and secrets are referenced by the github configuration file <strong>.github/workflows/awseb.yml</strong>,
which defines the deployment process and builds the commands used to deploy to AWS.</p>
</section>
</section>
</section>
<section id="aws-resources">
<h2><span class="section-number">8.3. </span>AWS Resources<a class="headerlink" href="#aws-resources" title="Permalink to this headline">#</a></h2>
<p>The final resource - Elastic Beanstalk - is clearly the most critical, and it is left until last. First, we need to
set up all the other resources required by the django web application.</p>
<section id="relational-database-postgres-rds">
<h3><span class="section-number">8.3.1. </span>Relational database (postgres RDS)<a class="headerlink" href="#relational-database-postgres-rds" title="Permalink to this headline">#</a></h3>
<p>postgres was selected as the database because it is well-supported by django, and also provides the best implementation
of a multi-tenanted database server, which is required by the architecture of RFStag.</p>
<p>There is an option to specify an RDS as an integral part of an AWS EB environment, but this has many disadvantages. Instead, even though
it was initially harder to set up, it’s best to create and use an external RDS.</p>
<section id="rds-setup">
<h4><span class="section-number">8.3.1.1. </span>RDS Setup<a class="headerlink" href="#rds-setup" title="Permalink to this headline">#</a></h4>
<p>For the moment, we are using a dedicated RDS on AWS. This is expensive ($USD24 ~= $AU35/month), but backups/snapshots
are automated.</p>
<p>Another option is to use a <a class="reference internal" href="#creating-a-low-cost-ec2-rds"><span class="xref myst">dedicated EC2 instance to run postgres</span></a>, and use that instead of a dedicated RDS. This option
is much cheaper, and seems to be just as responsive, but backups will need to be automated before this is used for production.</p>
<p>The <a class="reference internal" href="#creating-a-low-cost-ec2-rds"><span class="xref myst">EC2 postgres server</span></a> should be used for all other non-critical database needs.</p>
<p>To create a new RDS, go to <a class="reference external" href="https://ap-southeast-2.console.aws.amazon.com/rds/home?region=ap-southeast-2#">AWS RDS</a>, select DB instances,
and the Create Database. Refer to settings for production RDS, and copy them in general, but note the following:</p>
<ul class="simple">
<li><p>Choose a database creation method: Standard</p></li>
<li><p>Engine options: PostgreSQL (NB: Aurora [PostgreSQL Compatible] not tested ATM, and v expensive)</p></li>
<li><p>Engine Version: 14.10 (or same as production)</p></li>
<li><p>Templates: Free Tier</p></li>
<li><p>Settings/DB instance identifier: eg. bushfire2-prd-rds6</p></li>
<li><p>Settings/Credentials/Master username: <strong>RDS_USERNAME</strong></p></li>
<li><p>Settings/Credentials/Self Managed</p></li>
<li><p>Settings/Credentials/Master password: <strong>RDS_PASSWORD</strong></p></li>
<li><p>Instance Configuration:DB Instance Class: <strong>db.t3.micro</strong></p></li>
<li><p>Connectivity/Compute Resource: Don’t connect to an EC2 compute resource</p></li>
<li><p>Connectivity/Public Access: <strong>Yes</strong></p></li>
<li><p>Connectivity/VPC Security Group: <strong>Create New</strong></p></li>
<li><p>Connectivity/Existing VPC security groups: default</p></li>
<li><p>Connectivity/Database port: <strong>RDS_PORT</strong></p></li>
<li><p>Additional configuration/Initial database name: <strong>RDS_DB_NAME</strong></p></li>
<li><p>Additional configuration/Backups: On</p></li>
<li><p>Additional configuration/Encryption: On</p></li>
</ul>
<p>For new VPC security group, we will need to set Inbound Rules for any instances that need to use it.</p>
<p>Also provided access to dev machine, home IP address, so can be accessed with pgadmin.</p>
</section>
</section>
<section id="cache-redis-elasticache">
<h3><span class="section-number">8.3.2. </span>Cache (REDIS Elasticache)<a class="headerlink" href="#cache-redis-elasticache" title="Permalink to this headline">#</a></h3>
<p>Caches are used both for the <a class="reference external" href="https://docs.djangoproject.com/en/5.0/topics/cache/">django cache framework</a>, and to
support <a class="reference external" href="https://channels.readthedocs.io/en/1.x/backends.html#redis">django channels</a> in production use on AWS EB.</p>
<p>In AWS, a single <a class="reference external" href="https://ap-southeast-2.console.aws.amazon.com/elasticache/home?region=ap-southeast-2#/redis">Elasticache</a>
is shared across multiple applications. Key collisions are avoided by careful use of the
<strong>REDIS_KEY_PREFIX</strong> in settings.base which is calculated using the AWS EB hostname, plus the <strong>RDS_DB_NAME</strong>
and <strong>RDS_HOSTNAME</strong>, making it unique to each AWS EB environment.</p>
<p><strong>REDIS_KEY_PREFIX</strong> is used in <strong>settings.base.CHANNEL_LAYERS</strong> and <strong>settings.base.CACHES</strong>.</p>
<p>Also, we need to provide caching across multiple tenants/brigades, so a function <strong>kbfb/cache.make_key</strong> combines the
REDIS_KEY_PREFIX with the tenant name to make cache entries unique to each tenant as well.</p>
<p>The redis cache needs to provide read/write access to all web apps, and this is done by adding the Security Group <strong>default</strong>
to the cache definition, and ensuring that Inbound Rules on default allow the necessary access.</p>
<p>Apart from that, setup of the cache is straightforward, and should not cause problems, If necessary, use settings from
and existing cache as a guide.</p>
<ul class="simple">
<li><p><strong>REDIS_SERVER</strong>: Use the Primary Endpoint name for this</p></li>
<li><p><strong>REDIS_PORT</strong>: 6379 (default value)</p></li>
</ul>
<p>NB: The entire REDIS cache is cleared each time a new version is deployed to AWS. Unfortunately, this means deploying
to a tst environment will clear the prd cache, for the moment, until a smarter method is used.</p>
</section>
<section id="static-file-storage-s3-bucket">
<h3><span class="section-number">8.3.3. </span>Static file storage (<a class="reference external" href="https://ap-southeast-2.console.aws.amazon.com/s3/home?region=ap-southeast-2#">S3 bucket</a>)<a class="headerlink" href="#static-file-storage-s3-bucket" title="Permalink to this headline">#</a></h3>
<p>Django uses <a class="reference external" href="https://docs.djangoproject.com/en/5.0/howto/static-files/#how-to-manage-static-files-e-g-images-javascript-css">static files</a>
to store javascript, css, images, and other artifacts. A management command <strong>collectstatic</strong> is called from
.platform/hooks/postdeploy/02_django_setup.sh each time the app is deployed, and this keeps the static files updated.</p>
<p>There are a number of settings used for static files. These are quite simple in a development environment, but
complex for production. <a class="reference external" href="https://django-storages.readthedocs.io/en/latest/backends/amazon-S3.html">django-storages</a> is used to support storage in AWS S3 buckets, but there also
a number of CSP and other security  settings relating to js and css files.</p>
<p>Most AWS S3 settings are defined in <strong>settings.awseb</strong>, as they are not used anywhere other than on AWS EB.</p>
<p>The most important ones are defined in github actions:</p>
<ul class="simple">
<li><p><strong>AWS_STORAGE_BUCKET_NAME</strong> =   env(‘AWS_STORAGE_BUCKET_NAME’)</p></li>
<li><p><strong>AWS_ACCESS_KEY_ID</strong> =         env(‘AWS_ACCESS_KEY_ID’)</p></li>
<li><p><strong>AWS_SECRET_ACCESS_KEY</strong> =     env(‘AWS_SECRET_ACCESS_KEY’)</p></li>
</ul>
<p>It is quite tricky setting up S3 bucket permissions. A clear indication that this has not been done correctly
is when formatting of pages looks wrong, especially in admin which uses a lot of css.
There may aso be errors in the browser console that indicate problems loading static files.</p>
<p>NB: <strong>AWS_ACCESS_KEY_ID</strong> refers to the User who owns the bucket, and appropriate permissions must be set for that user.</p>
<p>It is best to copy an existing bucket, including permissions, to avoid these problems.</p>
<p>Changed Object Ownership (permissions) should have ACLs enabled, Bucket owner preferred</p>
</section>
<section id="logging-rotating-linux-logs">
<h3><span class="section-number">8.3.4. </span>Logging (rotating linux logs)<a class="headerlink" href="#logging-rotating-linux-logs" title="Permalink to this headline">#</a></h3>
<p>This mostly set up and controlled by scripts in .platform/hooks. It is still work in progress.</p>
<p>Ideally logs would be compressed and transferred to a S3 bucket for long term storage, but this
hasn’t been worked out yet.</p>
</section>
<section id="ip-routing-route-53-hosted-zones">
<h3><span class="section-number">8.3.5. </span>IP routing (Route 53 hosted zones)<a class="headerlink" href="#ip-routing-route-53-hosted-zones" title="Permalink to this headline">#</a></h3>
<p>Define a <a class="reference external" href="https://us-east-1.console.aws.amazon.com/route53/v2/hostedzones?region=ap-southeast-2#">hosted zone</a> for each registered domain name, that includes all valid hostnames, e.g. *.rfstag.com and rfstag.com.</p>
<p>The key values are for A type records, that define where traffic to the dmain name will be routed. The target will be
the AWS EB environment with the required web app version.</p>
<p>Note that when changing the target, you need to change for rfstag.com and *.rftstag.com (both A-records).</p>
<p>You also need to wait until the remapping is complete (view status), then advised to run a test to the domain name,
e.g. killara.rfstag.com, and confirm valid response is given.</p>
</section>
<section id="ssl-certification-aws-certificate-manager">
<h3><span class="section-number">8.3.6. </span>SSL certification (AWS Certificate Manager)<a class="headerlink" href="#ssl-certification-aws-certificate-manager" title="Permalink to this headline">#</a></h3>
<p>A security requirement is that <strong>https</strong> must always be used, rather than http. This requires an SSL certificate, which can be issued by
the <a class="reference external" href="https://ap-southeast-2.console.aws.amazon.com/acm/home?region=ap-southeast-2#/certificates/list">AWS Certificate Manager</a></p>
<p>The certificate used should cover all domains used in the application, e.g. *.rfstag.com, and *.rfstag.org.</p>
<p>It needs to be specified in the AWS EB Configuration of Instance Traffic Scaling/Load Balancer/Listeners section, for port 443 (https).</p>
<p>This is done in file <strong>.ebextensions/00_eb_setup.config</strong>, but can also be set in the AWS EB console.</p>
</section>
<section id="processor-disc-and-memory-elastic-beanstalk">
<h3><span class="section-number">8.3.7. </span>Processor, disc and memory (Elastic Beanstalk)<a class="headerlink" href="#processor-disc-and-memory-elastic-beanstalk" title="Permalink to this headline">#</a></h3>
<p>Last but not least, we need to define an Elastic Beanstalk environment to run the web application.</p>
<p>An AWS EB environment is contained in an EB application, so the application must be set up first. This can be done in
the AWS console, with little more than an application name being required.</p>
<p>Before creating a new EB environment, ensure that all code updates are saved in github. The <strong>eb create</strong> command below will
initialise the new environment with the latest version of bushfire2 code on the current github branch (usually <strong>master</strong>).</p>
<p>To add a new AWS EB environment, use the <strong><a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb3-create.html">eb create</a></strong>
command from the terminal command line in pycharm.</p>
<p>Responses:</p>
<ul class="simple">
<li><p>Environment name: e.g. bushfire2-tst7</p></li>
<li><p>DNS CNAME prefix: (as above)</p></li>
<li><p>Load Balancer Type: <strong>application</strong></p></li>
<li><p>Enable Spot Fleet requests: N</p></li>
</ul>
<p>This will create the new EB environment with the latest code base, including the configuration defined
in .ebextensions (see below).</p>
<p>It will not go through github actions, so <strong>no environment will be set</strong>.</p>
<p>The resulting environment will have the following characteristics:</p>
<ol class="arabic simple">
<li><p>It should be shown as healthy</p></li>
<li><p>It won’t run correctly, since the environment is not yet set up. This can be verified by looking at the environment configuration on AWS console.</p></li>
<li><p>It is not yet linked to a valid domain such as rfstag.com or rfstag.org, so nginx will not allow any traffic to reach it.</p></li>
<li><p>eb ssh to the new environment should work, so the linux image can be checked.</p></li>
</ol>
<p>To finish the deployment, you need to complete following steps:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#deploying-to-aws-eb-with-github-actions"><span class="xref myst">Deploy the system</span></a> to the required AWS EB using github actions.</p></li>
<li><p><a class="reference internal" href="#ip-routing-route-53-hosted-zones"><span class="xref myst">Redirect traffic</span></a> to the new AWS EB using AWS Route 53</p></li>
</ol>
<p>Note that the <strong>Application Load Balancer (ALB)</strong> is a critical part of the EB environment. It is set up
automatically during the eb create process, and takes a lot of config values from .ebextensions/00_eb_setup.config.</p>
<p>The ALB can be seen in the <a class="reference external" href="https://ap-southeast-2.console.aws.amazon.com/ec2/home?region=ap-southeast-2#Home:">EC2</a>
section of AWS, in the Load Balancer menu on the left. The target env can be quickly determined
by looking at the load balancer tags.</p>
<p>The ALB attributes should be checked to ensure that they are set up properly, in particular, <strong>Connection Idle Time</strong> should
be set from the default 60s to 300s to prevent server timeouts eg. when exporting large data sets.</p>
<section id="deploying-to-aws-eb-with-github-actions">
<h4><span class="section-number">8.3.7.1. </span>Deploying to AWS EB with Github Actions<a class="headerlink" href="#deploying-to-aws-eb-with-github-actions" title="Permalink to this headline">#</a></h4>
<p>AWS EB deployments were fraught with difficulty, with many problems relating to preparing and connecting the right
resources, in the right way, at the right time, when an update was applied.</p>
<p>There are some guides to deploying django application to AWS EB, but the landscape changes rapidly and many of them
are out of date.</p>
<p>Additional complexity is introduced by the requirements of RFStag for server-sent events (SSE) via django-channels, which
relies on websockets (not properly supported in AWS EB until recently), multi-tenanting to support many brigades
using django-tenants and postgresql, and security requirements such as Content Security Policy (CSP).</p>
<p>Initially, the various connections were made with a mixture of .ebextensions, settings files, guesswork, and a great deal
of luck when it worked.</p>
<p>Finally, when I was unable to change the RDS used by the production system, I realised I needed to radically improve the
deployment process to make it more reliable and predictable.</p>
<p>There were several options, but I landed on <a class="reference external" href="https://docs.github.com/en/actions">github actions</a> for the following reasons:</p>
<ol class="arabic simple">
<li><p>Already using github for source management</p></li>
<li><p>github actions is vendor independent, and can be made to work for AWS EB or any other hosting solution</p></li>
<li><p>Still free/low cost</p></li>
<li><p>Allows centralised storage of environment values and encryption of secrets</p></li>
<li><p>Allows switching between git branches and AWS EB environments</p></li>
<li><p>Allows scripted deployment procedures which can be tailored to the environment and can incorporate variables and secrets from github itself before deployment.</p></li>
</ol>
<section id="github-actions-settings">
<h5><span class="section-number">8.3.7.1.1. </span>Github Actions Settings<a class="headerlink" href="#github-actions-settings" title="Permalink to this headline">#</a></h5>
<p><a class="reference external" href="https://docs.github.com/en/actions">Github actions</a> is very powerful, and RFStag only uses a small part of the available functionality.</p>
<p>A single workflow is defined in <strong>.github/workflows/awseb.yml</strong> which does the following:</p>
<ol class="arabic simple">
<li><p>Checks out the current code base from the required git branch</p></li>
<li><p>Extracts variables and secrets from github actions and adds them to an AWS EB .extensions file to be used in deployment</p></li>
<li><p>Sends the deployment package to AWS to be stored in a S3 bucket</p></li>
<li><p>Triggers the AWS deployment process with the new deployment package</p></li>
<li><p><a class="reference external" href="https://docs.github.com/en/actions">Good documentation</a></p></li>
</ol>
</section>
<section id="github-actions-secrets-and-variables">
<h5><span class="section-number">8.3.7.1.2. </span>Github Actions Secrets and Variables<a class="headerlink" href="#github-actions-secrets-and-variables" title="Permalink to this headline">#</a></h5>
<p>The variables and secrets defined in github are used to define and characterise the resources used on AWS, such as
database (RDS), cache (REDIS), etc.</p>
<p>There are few <a class="reference external" href="https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions">secrets</a> (only passwords),
and everything else is defined as a <a class="reference external" href="https://docs.github.com/en/actions/learn-github-actions/variables">variable</a> and can be viewed
in <a class="reference external" href="https://github.com/ibowditch/bushfire2/settings/secrets/actions">github actions</a>.</p>
<p>As a general policy, settings defined in github actions should not have defaults when read from the environment (<strong>env</strong>(‘xxx’)),
and should not be defined anywhere else (for example in a separate .env file like <strong>bushfire/.env.awseb</strong>). This forces
the required values to be set in github actions, and if they are not, then there will an obvious error, e.g. the app
will fail immediately if no RDS settings are provided.</p>
<p>It also means that any environment variables required for the development environment, which doesn’t get deployed
through github actions, need to be defined in <strong>bushfire/.env.local</strong></p>
<p>Many of the actions variables and secrets are standard django values defined in <a class="reference external" href="https://docs.djangoproject.com/en/5.0/ref/settings/">django settings</a>
or in the associated django package, such as <a class="reference external" href="https://channels.readthedocs.io/en/stable/introduction.html">django-channels</a>,
<a class="reference external" href="https://django-tenants.readthedocs.io/en/latest/">django-tenants</a>, etc.</p>
<p>Many <a class="reference external" href="https://docs.github.com/en/actions/learn-github-actions/variables">variables</a>, and a few secrets are defined as
Repository variables, rather than environment variables. Respository variables are the same for all environments,
and only need to be defined once. They can be overridden in a specific environment, which gives priority to
environment rather than repository variables when resolving them.</p>
<p>The other significant ones are as follows:</p>
<ul class="simple">
<li><p><strong>DEPLOY_ENV</strong>: defines the name of the github actions environment where specific env variables and secrets are defined.
Also gives the name of the AWS EB environment to deploy to. Generally set to the test environment, and only prd on special occasions.</p></li>
<li><p><strong>DOMAIN_[ROOT,SUFFIX]</strong>: Defines the full domain name, so should be ROOT=rfstag, SUFFIX=org for test, SUFFIX=com for prd</p></li>
<li><p><strong>AWS_ENV_SUFFIX</strong>: when appended to <strong>EB_APP_NAME</strong>, gives the name of the AWS EB environment, e.g. bushfire2-prd2</p></li>
</ul>
</section>
</section>
<section id="elastic-beanstalk-extensions">
<h4><span class="section-number">8.3.7.2. </span>Elastic Beanstalk Extensions<a class="headerlink" href="#elastic-beanstalk-extensions" title="Permalink to this headline">#</a></h4>
<p>Most of the basic required configuration so far has been done with <strong><a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html">.ebextensions</a></strong>.</p>
<p>In particular <strong>.ebextensions/00_eb_setup.config</strong>, sets up the following:</p>
<ul class="simple">
<li><p>EC2 security group default</p></li>
<li><p>Application Load Balancer (ALB) Listener for 443 (https), including valid SSL Certificate</p></li>
<li><p>ALB Process <strong>default</strong> which handles all http traffic (including health checks)</p></li>
<li><p>ALB Process <strong>websocket</strong> which handles all websocket traffic including django channels</p></li>
<li><p>ALB Listener rule for websockets</p></li>
<li><p>EC2 Key Name to allow ssh connections to instance</p></li>
</ul>
<p>The above settings are the same for all environments in the application, and should not be changed for a particular environment.</p>
<p><strong>.ebextensions/django.config</strong> also sets up <strong>WSGIPath</strong>, and <strong>.ebextensions/secrets.config</strong> is also needed as a placeholder for
AWS EB configuration settings (see <a class="reference internal" href="#github-actions-settings"><span class="xref myst">above</span></a>).</p>
<p><strong>No other .ebextensions should be used.</strong></p>
<div class="admonition-why-use-ebextensions admonition">
<p class="admonition-title">Why use .ebextensions?</p>
<p>.ebextensions were the only way to <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html">extend AWS EB configuration</a>
until fairly recently, and RFStag used them in the early years.</p>
<p>Then AWS introduced Linux 2, which allowed control via platform hooks, which are linux scripts run during the
deployment process, as well as finer control over the nginx reverse proxy.</p>
<p>.ebextensions are still used, but they must be used with great care, and very sparingly.
Sometimes they are applied, and sometimes not. Platform
hooks are the recommended way to change settings and configuration, so I now avoid using .ebextensions where possible.</p>
<p><strong>.ebextensions/00_eb_setup.config</strong> is the exception, since it is generic and applies to all environments within an
EB application and is also useful for initialising an environment, especially the ALB which can be very tricky to do
otherwise.</p>
</div>
</section>
<section id="aws-eb-platform-settings">
<h4><span class="section-number">8.3.7.3. </span>AWS EB .platform settings<a class="headerlink" href="#aws-eb-platform-settings" title="Permalink to this headline">#</a></h4>
<p>Since the introduction of linux 2 platforms in AWS EB, <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html">.platform</a>
has been the main way to tailor AWS EB configurations. RFStag uses the following <strong>.platform</strong> configurations to set up the AWS EB instances:</p>
<section id="platform-confighooks">
<h5><span class="section-number">8.3.7.3.1. </span>.platform confighooks<a class="headerlink" href="#platform-confighooks" title="Permalink to this headline">#</a></h5>
<ol class="arabic simple">
<li><p>confighooks/postdeploy/set_env: This makes the EB environment variables available in an ssh session</p></li>
</ol>
</section>
<section id="platform-hooks">
<h5><span class="section-number">8.3.7.3.2. </span>.platform hooks<a class="headerlink" href="#platform-hooks" title="Permalink to this headline">#</a></h5>
<ol class="arabic simple">
<li><p>hooks/postdeploy/<em>logging</em>: set up log rotation and bundling by editing EB files in situ</p></li>
<li><p>hooks/postdeploy/django_setup: Creates logging directories, runns collectstatic and migrate_schemas to update everything</p></li>
<li><p>hooks/postdeploy/reset_cache: Erases the cache to force refresh of all pages using the new environment</p></li>
</ol>
</section>
<section id="platform-nginx">
<h5><span class="section-number">8.3.7.3.3. </span>.platform nginx<a class="headerlink" href="#platform-nginx" title="Permalink to this headline">#</a></h5>
<p><a class="reference external" href="https://docs.nginx.com/">NGINX</a> is the reverse proxy used by default on all AWS EB environments. It is the first
point at which requests can be examined, and it is used to filter out invalid and irrelevant requests. It can handle
high volumes of requests quicker than django, so it improves performance and responsiveness, as long as it is set up
properly (which is something of a black art).</p>
<p>RFStag nginx settings were modelled on a <a class="reference external" href="https://gist.github.com/henhan/2943013c9064606425b0ee5bb1ca8c99">github gist</a>,
with some additional modifications. The configuration does the following:</p>
<ol class="arabic simple">
<li><p>Enforces <strong>https</strong> for all external communications (internal AWS health checks excluded)</p></li>
<li><p>Logs, and rotates, all requests in <strong>/var/log/nginx</strong> files.</p></li>
<li><p>Filters out any non-conformant urls/hosts using nginx_env.conf <strong>$gd_host</strong>, and returns http code 400 if rejected</p></li>
<li><p>Diverts websocket requests to the <strong>daphne</strong> process that handles django-channels (see also <strong>Procfile</strong>)</p></li>
</ol>
<p>Any requests that pass through this initial nginx filter are passed on to django.</p>
</section>
<section id="django-middleware">
<h5><span class="section-number">8.3.7.3.4. </span>Django Middleware<a class="headerlink" href="#django-middleware" title="Permalink to this headline">#</a></h5>
<p>If they pass through the nginx reverse proxy filtering process, requests will be passed through to RFStag middleware
(see settings.base.MIDDLEWARE).</p>
<p>This is mostly boilerplate, with the following exceptions:</p>
<ol class="arabic simple">
<li><p><strong>csp.middleware.CSPMiddleware</strong>: Used to check Content Security Policy - see security below</p></li>
<li><p><strong>tenants.middleware2.TenantAWSMiddleWare</strong>: Used to route requests to the appropriate tenant.</p></li>
<li><p><strong>kbfb.middleware2.LoginRequiredMiddleware</strong>: Used to enforce login required for each tenant</p></li>
</ol>
<div class="admonition-unexpected-404-errors admonition">
<p class="admonition-title">Unexpected 404 errors</p>
<p>The most likely cause of unexpected 404 errors is that one of the settings is not set correctly,
starting with DJANGO_SETTINGS_MODULE.</p>
<p>You can see all settings on the AWS EB console/Configuration, or alternatively, run the url /crash500 and an email
will be sent with a full listing of all settings.</p>
<p>Further investigations can be done by adding or enabling DEBUG output from middleware, by changing the
relevant settings.base.LOGGING[loggers][level], or adding more logging to middleware if needed.</p>
</div>
</section>
</section>
</section>
<section id="creating-a-low-cost-ec2-rds">
<h3><span class="section-number">8.3.8. </span>Creating a low-cost EC2 RDS<a class="headerlink" href="#creating-a-low-cost-ec2-rds" title="Permalink to this headline">#</a></h3>
<p><a class="reference external" href="https://aws-postgresql-docs.beliciarodriguez.com/launching-instance/overview">ref</a></p>
<p>230808</p>
<p>Ec2 db experiment: summary of steps</p>
<ul>
<li><p>Create a new ec2 instance</p></li>
<li><p>Create a new key pair and use that for connection</p></li>
<li><p>Create a new security group using the wizard</p></li>
<li><p>Set inbound rules for this new security group to allow connection from My IP</p></li>
<li><p>Ssh to new instance</p></li>
<li><p>Find instance on aws ec2 dashboard</p></li>
<li><p>Click connect</p></li>
<li><p>Copy template ssh command</p></li>
<li><p>In shell, Paste ssh command to command line</p></li>
<li><p>Edit to change location of .pem file</p></li>
<li><p>Result: ssh -i “.ssh/aws-postgres-ec2.pem” ubuntu&#64;ec2-52-62-233-21.ap-southeast-2.compute.amazonaws.com</p></li>
<li><p>Install postgres
sudo apt-get update -y &amp;&amp; sudo apt-get upgrade -y
sudo apt install postgresql -y</p></li>
<li><p>Edit postgres config files: see https://betterprogramming.pub/how-to-provision-a-cheap-postgresql-database-in-aws-ec2-9984ff3ddaea
sudo nano /etc/postgresql/14/main/postgresql.conf
sudo nano /etc/postgresql/14/main/pg_hba.conf
sudo systemctl restart postgresql</p>
<ul class="simple">
<li><p>Setup roles for ubuntu and ian
ubuntu&#64;ip-172-31-7-181:~$ sudo -u  postgres psql
could not change directory to “/home/ubuntu”: Permission denied
psql (14.8 (Ubuntu 14.8-0ubuntu0.22.04.1))
Type “help” for help.</p></li>
</ul>
<p>postgres=# psql -U postgres -c “CREATE ROLE ubuntu;”
postgres-# psql -U postgres -c “ALTER ROLE  ubuntu  WITH LOGIN;”
postgres-# psql -U postgres -c “ALTER USER  ubuntu  CREATEDB;”
postgres-# psql -U postgres -c “ALTER USER  ubuntu  WITH PASSWORD ‘ubuntu’;”
postgres-# exit
Use \q to quit.
postgres-# \q</p>
</li>
<li><p>For ian
ubuntu&#64;ip-172-31-7-181:~$ sudo -u  postgres psql
could not change directory to “/home/ubuntu”: Permission denied
psql (14.8 (Ubuntu 14.8-0ubuntu0.22.04.1))
Type “help” for help.</p>
<p>postgres=# CREATE ROLE ian;
postgres=# ALTER ROLE  ian  WITH LOGIN;
ALTER ROLE
postgres=# ALTER USER ian  CREATEDB;
ALTER ROLE
postgres=# ALTER USER ian  WITH PASSWORD ‘ib151258’;
ALTER ROLE
postgres=# \q</p>
</li>
<li><p>Restart postgres
ubuntu&#64;ip-172-31-7-181:~$ sudo systemctl restart postgresql</p></li>
<li><p>Connect to instance using pgadmin with user ian
Pgadmin new connection:
General
Name: aws-postgres-ec2
Connection:
Host: ec2-52-62-233-21.ap-southeast-2.compute.amazonaws.com
Port: 5432
Maintenance Database: postgres
Username: ian
Password (first time) ib15..</p></li>
<li><p>Connect to ec2 with this connection (important that user=ian)
Create database, with owner ian
Then restore into new db from a prd backup, e.g. /home/ian/kbfb/aws-backups/bushfire2-prd-rds-230804
Set tpad to connect to this db</p></li>
<li><p>/home/ian/PycharmProjects/bushfire2/bushfire/settings/.env</p></li>
<li></li>
<li><p>aws-postgresql-ec2
RDS_HOSTNAME=ec2-52-62-233-21.ap-southeast-2.compute.amazonaws.com
RDS_DB_NAME=rfstag3-ec2
…
RDS_USERNAME=ian
RDS_PASSWORD=ib151258
Run bushfire2 and login to http://kuringai.signin.org:8069/bfb/
User tagadmin</p></li>
</ul>
</section>
<section id="security-settings-mozilla-observatory">
<h3><span class="section-number">8.3.9. </span>Security Settings <a class="reference external" href="https://observatory.mozilla.org/">Mozilla Observatory</a><a class="headerlink" href="#security-settings-mozilla-observatory" title="Permalink to this headline">#</a></h3>
<p><a class="reference external" href="https://blogthedata.com/post/how-to-get-a-perfect-mozilla-observatory-score/">ref1 </a></p>
<p><a class="reference external" href="https://blogthedata.com/post/how-to-implement-subresource-integrity-django/">ref2 </a></p>
</section>
</section>
<section id="aws-eb-platforms">
<h2><span class="section-number">8.4. </span>AWS EB Platforms<a class="headerlink" href="#aws-eb-platforms" title="Permalink to this headline">#</a></h2>
<p>In general, the <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platform-history-python.html">latest available EC2 platform</a>
should be used for testing and production where possible.</p>
<p>This avoids major jumps between versions, and the compatibility problems that brings.</p>
<p>Leave the production version on a LTS (long term support) version where possible, rather than a minor release.</p>
<p>RFStag has limited automatic testing available, and regression testing is rudimentary, so staying current
with latest releases reduces the risk of major problems by identifying them early.</p>
<section id="ec2-platform-version-upgrades">
<h3><span class="section-number">8.4.1. </span>EC2 Platform Version Upgrades<a class="headerlink" href="#ec2-platform-version-upgrades" title="Permalink to this headline">#</a></h3>
<p>Platform <strong>version upgrades</strong> can normally be done safely using the AWS EB <a class="reference external" href="https://ap-southeast-2.console.aws.amazon.com/elasticbeanstalk/home?region=ap-southeast-2#/environments">environment console</a></p>
<p>Occasionally, version upgrades go wrong, so it’s important to upgrade the version first using a test environment. Check the logs for
any errors or suspicious messages, and make sure all is well before deploying to production.</p>
</section>
<section id="upgrading-ec2-platform">
<h3><span class="section-number">8.4.2. </span>Upgrading EC2 Platform<a class="headerlink" href="#upgrading-ec2-platform" title="Permalink to this headline">#</a></h3>
<p>There are many different platforms available for EC2 instances. The python platforms normally have a python version number, and a linux type -
see <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platform-history-python.html">Python Platform History</a> for details.</p>
<p>It isn’t possible to change the platform for an environment once it has been deployed. Changing version is ok
(using the AWS EB environment console), but if a new platform is needed, and new environment must be created.</p>
<p>To do that, follow these steps:</p>
<ol class="arabic simple">
<li><p>In pycharm terminal, <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb3-platform.html"><strong>eb platform select</strong></a></p></li>
</ol>
<ul class="simple">
<li><p>Choose the new platform branch to use for subsequent environments. This value will be stored in
<strong>.elasticbeanstalk/config.yml</strong> as global:<strong>default_platform</strong>.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>Now create the new environment using <a class="reference external" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb3-create.html"><strong>eb create</strong></a></p></li>
</ol>
<ul class="simple">
<li><p>Choose the environment name carefully, as it will be used in the github deployment chain. e.g. for (existing)
EB application bushfire2, choose bushfire2-tst8.</p></li>
<li><p>Choose an application load balancer</p></li>
<li><p>eb create will set up all the infrastructure required to run the environment.</p></li>
<li><p>It will also pass on the latest source package, so make sure all files have been checked into github.</p></li>
<li><p>NB: The github deployment procedure will NOT be followed when using eb create, so many critical environment
variables, which are set in the github deployment script <strong>.github/workflows/awseb.yml</strong> will not be set in the
new EB environment. The deployment will only partially work, and will probably show failing health.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Set up the github deployment environment</p></li>
</ol>
<ul class="simple">
<li><p>Go to <a class="reference external" href="https://github.com/ibowditch/bushfire2/settings/environments">github environments</a> and create a new environment</p></li>
<li><p>Copy values from an existing environment.</p></li>
<li><p>Re-use secrets for S3 buckets</p></li>
<li><p>Generate a new Django secret</p></li>
<li><p>Make sure AWS_ENV_SUFFIX is set to match the new envronment name suffix (e.g. tst8)</p></li>
<li><p>Make sure the DOMAIN_SUFFIX is set correctly (usually org)</p></li>
<li><p>Probably create a new RDS in EC2 RDS, and set django RDS* variables pointing to it.</p></li>
<li><p>Re-use the existing REDIS server (keys will be different, so easy to share)</p></li>
<li><p>Finally, make sure repository variable <strong>DEPLOY_ENV</strong> is set to the appropriate value, i.e. the new github
environment name (bushfire2-tst8).</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p>Deploy to the new environment via github</p></li>
</ol>
<ul class="simple">
<li><p>If needed, make a dummy edit to a file, then Commit and Push the latest version to github.</p></li>
<li><p>This will trigger the github deployment script <strong>.github/workflows/awseb.yml</strong>.</p></li>
<li><p>Environment variables will be set in github, and then passed on to the new EB environment.</p></li>
<li><p>If all variables are set correctly, the new environment should now show good health.</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p>Redirect the host domain to the new environment</p></li>
</ol>
<ul class="simple">
<li><p>Go to <a class="reference external" href="https://us-east-1.console.aws.amazon.com/route53/v2/hostedzones?region=ap-southeast-2#">Route 53 dashboard</a>
and select the required hosted zone.</p></li>
<li><p>Edit the A-type records for eg. <strong>rfstag.org</strong> and <strong>.rfstag.org</strong> to point to the new environment.</p></li>
<li><p>Wait until the change is completed</p></li>
<li><p>Test the record to ensure and OK value is returned.</p></li>
<li><p>Now try running the appropriate host, eg. <a class="reference external" href="https://kuringai.rfstag.org">kuringai.rfstag.org</a>, and confirm working as expected.</p></li>
</ul>
</section>
<section id="common-issues-when-upgrading-ec2-platform">
<h3><span class="section-number">8.4.3. </span>Common Issues when Upgrading EC2 Platform<a class="headerlink" href="#common-issues-when-upgrading-ec2-platform" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Python dependencies. Check messages.log, eb-engine.log, rfstag.log for hints. Update <strong>Pipfile</strong> if needed.</p></li>
<li><p>channels/daphne: try running daphne on the ec2 command line and see if running. Check systemctl status websocket</p></li>
<li><p>Caching: cache should be cleared on deployment by .platform/hooks/postdeploy/04_reset_cache.sh, but confirm this.</p></li>
<li><p>Environment variables not set correctly. These can be viewed in the AWS env configuration - check carefully.
Investigate, and check awseb.yml is working as expected, and github variables set properly.</p></li>
</ul>
</section>
</section>
</section>


                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="technology.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Technology (Under construction)</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">7. Internal Procedures (Under construction)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-brigade">7.1. Adding a New Brigade</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-required-from-brigade">7.1.1. Data Required from Brigade</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-order-parts-list">7.1.2. Hardware Order Parts List</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#equipment-to-be-provided-by-brigade">7.1.3. Equipment to be Provided by Brigade</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-tenant-schema">7.1.4. Adding a New Tenant Schema</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-a-new-kiosk-raspberry-pi">7.1.5. Setting Up a New Kiosk Raspberry PI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-the-kiosk-software-apt-procedure">7.1.6. Installing the Kiosk Software (apt procedure)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-preparation">7.1.6.1. Initial Preparation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#add-the-rfstag-kiosk-repository-one-off-procedure">7.1.6.2. Add the rfstag-kiosk repository (one-off procedure)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pi-display-problems-and-vnc-connections">7.1.6.3. PI display problems and VNC connections</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#first-installation">7.1.6.4. First installation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#update-2024-08-22">7.1.6.5. Update 2024-08-22</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-the-nfcserver2-package">7.1.7. Building the nfcserver2 package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-screen-keyboard">7.1.8. On screen keyboard</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-activ-dashboard-on-the-pi">7.1.8.1. Running the ACTIV dashboard on the PI</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-the-kiosk-software-original-procedure">7.1.9. Installing the Kiosk Software (original procedure)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-login">7.1.10. First login</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-remote-it">7.1.11. Check remote.it</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">7.1.12. Testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-deployment-to-prd">7.1.13. Full Deployment to PRD</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-new-elasticache-on-aws">7.2. Create new Elasticache on AWS</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rds">7.3. RDS</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copy-prd-rds-to-dev-env">7.3.1. Copy prd RDS to dev env</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-models-migrations">7.3.2. Updating Models/Migrations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-credits-annual">7.4. AWS Credits (annual)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-userdocs">7.5. Updating userdocs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-new-pager-sub-system">7.6. Adding a New Pager Sub-system</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pi-won-t-boot">7.7. PI won’t boot</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-deployment">8. AWS Deployment</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-deployment-checklist">8.1. AWS Deployment Checklist</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings-for-web-application-deployment">8.2. Settings for Web Application Deployment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#django-settings">8.2.1. Django Settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-variables-as-settings">8.2.2. Environment Variables as settings</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#django-setting-allowed-hosts">8.2.2.1. Django Setting ALLOWED_HOSTS</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#development-environment-variables">8.2.2.2. Development Environment Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment-environment-variables">8.2.2.3. Deployment Environment Variables</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-resources">8.3. AWS Resources</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#relational-database-postgres-rds">8.3.1. Relational database (postgres RDS)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rds-setup">8.3.1.1. RDS Setup</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cache-redis-elasticache">8.3.2. Cache (REDIS Elasticache)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-file-storage-s3-bucket">8.3.3. Static file storage (S3 bucket)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logging-rotating-linux-logs">8.3.4. Logging (rotating linux logs)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ip-routing-route-53-hosted-zones">8.3.5. IP routing (Route 53 hosted zones)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ssl-certification-aws-certificate-manager">8.3.6. SSL certification (AWS Certificate Manager)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processor-disc-and-memory-elastic-beanstalk">8.3.7. Processor, disc and memory (Elastic Beanstalk)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-to-aws-eb-with-github-actions">8.3.7.1. Deploying to AWS EB with Github Actions</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#github-actions-settings">8.3.7.1.1. Github Actions Settings</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#github-actions-secrets-and-variables">8.3.7.1.2. Github Actions Secrets and Variables</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#elastic-beanstalk-extensions">8.3.7.2. Elastic Beanstalk Extensions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-eb-platform-settings">8.3.7.3. AWS EB .platform settings</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-confighooks">8.3.7.3.1. .platform confighooks</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-hooks">8.3.7.3.2. .platform hooks</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-nginx">8.3.7.3.3. .platform nginx</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#django-middleware">8.3.7.3.4. Django Middleware</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-low-cost-ec2-rds">8.3.8. Creating a low-cost EC2 RDS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#security-settings-mozilla-observatory">8.3.9. Security Settings Mozilla Observatory</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aws-eb-platforms">8.4. AWS EB Platforms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ec2-platform-version-upgrades">8.4.1. EC2 Platform Version Upgrades</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrading-ec2-platform">8.4.2. Upgrading EC2 Platform</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-issues-when-upgrading-ec2-platform">8.4.3. Common Issues when Upgrading EC2 Platform</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ian Bowditch email:ibowditch@gmail.com
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022, Ian Bowditch.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>